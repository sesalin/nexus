{"version":3,"file":"index.js","sources":["../../../../src/hooks/useTemplate/index.ts"],"sourcesContent":["import { useRef, useEffect, useMemo, useState } from \"react\";\nimport { EntityName, useHass } from \"@core\";\nimport { MessageBase, UnsubscribeFunc } from \"home-assistant-js-websocket\";\n\ntype RenderTemplateResult = {\n  result: string;\n} & MessageBase;\n\ntype RenderTemplateError = {\n  error: string;\n  label: string;\n};\n\nexport type TemplateParams = {\n  /** The template expression to process */\n  template: string;\n  /** The entity ids or id to watch for changes, @deprecated This may not be needed as variables should handle this case */\n  entity_ids?: EntityName | EntityName[];\n  /** variables to define to use within the template\n   * @example\n   * variables: { entity_id: 'climate.air_conditioner' }\n   * you can now use entity_id in your template expression\n   */\n  variables?: Record<string, unknown>;\n  /** amount of time that should pass before aborting the template request @default undefined */\n  timeout?: number;\n  /** should the template renderer be strict, raise on undefined variables etc @default false */\n  strict?: boolean;\n  /** should the template renderer report any errors @default false */\n  report_errors?: boolean;\n  /** Determines if the subscription should be active. @default true */\n  enabled?: boolean;\n};\n\nexport const useTemplate = (params: TemplateParams) => {\n  const connection = useHass((state) => state.connection);\n  const [template, setTemplate] = useState<string | object | null>(null);\n  const unsubscribeRef = useRef<UnsubscribeFunc | null>(null);\n  const memoizedParams = useMemo(() => params, [params]);\n\n  useEffect(() => {\n    const unsubscribe = () => {\n      if (unsubscribeRef.current) {\n        try {\n          unsubscribeRef.current();\n        } catch {\n          // May have already unsubscribed\n        } finally {\n          unsubscribeRef.current = null;\n        }\n      }\n    };\n    const { enabled = true, ...restParams } = memoizedParams;\n\n    if (!enabled || !connection) {\n      unsubscribe();\n      if (!enabled) {\n        setTemplate(null);\n      }\n      return;\n    }\n\n    const handleResponse = (response: RenderTemplateResult | RenderTemplateError) => {\n      if (\"error\" in response) {\n        console.error(\"Error processing template:\", response.error);\n        // We show the latest error, or a warning if there are no errors\n        setTemplate(response.error);\n        return;\n      }\n      setTemplate((previous) => (previous === response.result ? previous : response.result));\n    };\n\n    const handleError = (err: RenderTemplateError) => {\n      console.error(\"Error processing template:\", err);\n      setTemplate(err?.error || \"Could not process template request.\");\n    };\n\n    connection\n      .subscribeMessage(handleResponse, {\n        type: \"render_template\",\n        ...restParams,\n      })\n      .then((unsub) => {\n        unsubscribeRef.current = unsub;\n      })\n      .catch((e: RenderTemplateError) => {\n        console.error(\"Error subscribing to template:\", e);\n        handleError(e);\n      });\n\n    return unsubscribe;\n  }, [connection, memoizedParams]);\n\n  return template;\n};\n"],"names":["useTemplate","params","connection","useHass","state","template","setTemplate","useState","unsubscribeRef","useRef","memoizedParams","useMemo","useEffect","unsubscribe","enabled","restParams","handleResponse","response","previous","handleError","err","unsub"],"mappings":"2UAkCO,MAAMA,EAAeC,GAA2B,CACrD,MAAMC,EAAaC,EAAAA,QAASC,GAAUA,EAAM,UAAU,EAChD,CAACC,EAAUC,CAAW,EAAIC,EAAAA,SAAiC,IAAI,EAC/DC,EAAiBC,EAAAA,OAA+B,IAAI,EACpDC,EAAiBC,EAAAA,QAAQ,IAAMV,EAAQ,CAACA,CAAM,CAAC,EAErDW,OAAAA,EAAAA,UAAU,IAAM,CACd,MAAMC,EAAc,IAAM,CACxB,GAAIL,EAAe,QACjB,GAAI,CACFA,EAAe,QAAA,CACjB,MAAQ,CAER,QAAA,CACEA,EAAe,QAAU,IAC3B,CAEJ,EACM,CAAE,QAAAM,EAAU,GAAM,GAAGC,GAAeL,EAE1C,GAAI,CAACI,GAAW,CAACZ,EAAY,CAC3BW,EAAA,EACKC,GACHR,EAAY,IAAI,EAElB,MACF,CAEA,MAAMU,EAAkBC,GAAyD,CAC/E,GAAI,UAAWA,EAAU,CACvB,QAAQ,MAAM,6BAA8BA,EAAS,KAAK,EAE1DX,EAAYW,EAAS,KAAK,EAC1B,MACF,CACAX,EAAaY,GAAcA,IAAaD,EAAS,OAASC,EAAWD,EAAS,MAAO,CACvF,EAEME,EAAeC,GAA6B,CAChD,QAAQ,MAAM,6BAA8BA,CAAG,EAC/Cd,EAAYc,GAAK,OAAS,qCAAqC,CACjE,EAEA,OAAAlB,EACG,iBAAiBc,EAAgB,CAChC,KAAM,kBACN,GAAGD,CAAA,CACJ,EACA,KAAMM,GAAU,CACfb,EAAe,QAAUa,CAC3B,CAAC,EACA,MAAO,GAA2B,CACjC,QAAQ,MAAM,iCAAkC,CAAC,EACjDF,EAAY,CAAC,CACf,CAAC,EAEIN,CACT,EAAG,CAACX,EAAYQ,CAAc,CAAC,EAExBL,CACT"}