{"version":3,"file":"getFloorsAndAreas.js","sources":["../../../../src/hooks/useAreas/getFloorsAndAreas.ts"],"sourcesContent":["import {\n  computeDomain,\n  computeAreaName,\n  computeFloorName,\n  type DeviceRegistryEntry,\n  type AreaRegistryEntry,\n  type FloorRegistryEntry,\n  type EntityListInfoCommon,\n  stringCompare,\n  EntityName,\n  type EntityRegistryDisplayEntry,\n  useHass,\n} from \"@core\";\nimport { type HassEntity } from \"home-assistant-js-websocket\";\n\nexport interface UseAreasReturn extends EntityListInfoCommon {\n  type: \"floor\" | \"area\";\n  floor?: FloorRegistryEntry;\n  area?: AreaRegistryEntry;\n}\n\ntype DeviceEntityDisplayLookup = Record<string, EntityRegistryDisplayEntry[]>;\n\nconst getDeviceEntityDisplayLookup = (entities: EntityRegistryDisplayEntry[]): DeviceEntityDisplayLookup => {\n  const deviceEntityLookup: DeviceEntityDisplayLookup = {};\n  for (const entity of entities) {\n    if (!entity.device_id) {\n      continue;\n    }\n    if (!(entity.device_id in deviceEntityLookup)) {\n      deviceEntityLookup[entity.device_id] = [];\n    }\n    deviceEntityLookup[entity.device_id].push(entity);\n  }\n  return deviceEntityLookup;\n};\n\ntype FloorAreaLookup = Record<string, AreaRegistryEntry[]>;\n\nconst floorCompare = (entries?: Record<string, FloorRegistryEntry>, order?: string[]) => (a: string, b: string) => {\n  const indexA = order ? order.indexOf(a) : -1;\n  const indexB = order ? order.indexOf(b) : -1;\n  if (indexA === -1 && indexB === -1) {\n    const floorA = entries?.[a];\n    const floorB = entries?.[b];\n    if (floorA && floorB && floorA.level !== floorB.level) {\n      return (floorB.level ?? -9999) - (floorA.level ?? -9999);\n    }\n    const nameA = floorA?.name ?? a;\n    const nameB = floorB?.name ?? b;\n    return stringCompare(nameA, nameB);\n  }\n  if (indexA === -1) {\n    return 1;\n  }\n  if (indexB === -1) {\n    return -1;\n  }\n  return indexA - indexB;\n};\n\nexport const getFloorAreaLookup = (areas: AreaRegistryEntry[]): FloorAreaLookup => {\n  const floorAreaLookup: FloorAreaLookup = {};\n  for (const area of areas) {\n    if (!area.floor_id) {\n      continue;\n    }\n    if (!(area.floor_id in floorAreaLookup)) {\n      floorAreaLookup[area.floor_id] = [];\n    }\n    floorAreaLookup[area.floor_id].push(area);\n  }\n  return floorAreaLookup;\n};\n\nexport const useAreas = (\n  includeDomains?: string[],\n  excludeDomains?: string[],\n  includeDeviceClasses?: string[],\n  deviceFilter?: (device: DeviceRegistryEntry) => boolean,\n  entityFilter?: (entityId: HassEntity) => boolean,\n  excludeAreas?: string[],\n  excludeFloors?: string[],\n): UseAreasReturn[] => {\n  const { joinHassUrl } = useHass.getState().helpers;\n  const _entities = useHass((store) => store.entities);\n  const _entitiesRegistryDisplay = useHass((store) => store.entitiesRegistryDisplay);\n  const _devices = useHass((store) => store.devices);\n  const _areas = useHass((store) => store.areas);\n  const _floors = useHass((store) => store.floors);\n  const floors = Object.values(_floors);\n  const areas = Object.values(_areas);\n  const devices = Object.values(_devices);\n  const entities = Object.values(_entitiesRegistryDisplay);\n\n  let deviceEntityLookup: DeviceEntityDisplayLookup = {};\n  let inputDevices: DeviceRegistryEntry[] | undefined;\n  let inputEntities: EntityRegistryDisplayEntry[] | undefined;\n\n  if (includeDomains || excludeDomains || includeDeviceClasses || deviceFilter || entityFilter) {\n    deviceEntityLookup = getDeviceEntityDisplayLookup(entities);\n    inputDevices = devices;\n    inputEntities = entities.filter((entity) => entity.area_id);\n\n    if (includeDomains) {\n      inputDevices = inputDevices!.filter((device) => {\n        const devEntities = deviceEntityLookup[device.id];\n        if (!devEntities || !devEntities.length) {\n          return false;\n        }\n        return deviceEntityLookup[device.id].some((entity) => includeDomains.includes(computeDomain(entity.entity_id as EntityName)));\n      });\n      inputEntities = inputEntities!.filter((entity) => includeDomains.includes(computeDomain(entity.entity_id as EntityName)));\n    }\n\n    if (excludeDomains) {\n      inputDevices = inputDevices!.filter((device) => {\n        const devEntities = deviceEntityLookup[device.id];\n        if (!devEntities || !devEntities.length) {\n          return true;\n        }\n        return entities.every((entity) => !excludeDomains.includes(computeDomain(entity.entity_id as EntityName)));\n      });\n      inputEntities = inputEntities!.filter((entity) => !excludeDomains.includes(computeDomain(entity.entity_id as EntityName)));\n    }\n\n    if (includeDeviceClasses) {\n      inputDevices = inputDevices!.filter((device) => {\n        const devEntities = deviceEntityLookup[device.id];\n        if (!devEntities || !devEntities.length) {\n          return false;\n        }\n        return deviceEntityLookup[device.id].some((entity) => {\n          const stateObj = _entities[entity.entity_id];\n          if (!stateObj) {\n            return false;\n          }\n          return stateObj.attributes.device_class && includeDeviceClasses.includes(stateObj.attributes.device_class);\n        });\n      });\n      inputEntities = inputEntities!.filter((entity) => {\n        const stateObj = _entities[entity.entity_id];\n        return stateObj.attributes.device_class && includeDeviceClasses.includes(stateObj.attributes.device_class);\n      });\n    }\n\n    if (deviceFilter) {\n      inputDevices = inputDevices!.filter((device) => deviceFilter!(device));\n    }\n\n    if (entityFilter) {\n      inputDevices = inputDevices!.filter((device) => {\n        const devEntities = deviceEntityLookup[device.id];\n        if (!devEntities || !devEntities.length) {\n          return false;\n        }\n        return deviceEntityLookup[device.id].some((entity) => {\n          const stateObj = _entities[entity.entity_id];\n          if (!stateObj) {\n            return false;\n          }\n          return entityFilter(stateObj);\n        });\n      });\n      inputEntities = inputEntities!.filter((entity) => {\n        const stateObj = _entities[entity.entity_id];\n        if (!stateObj) {\n          return false;\n        }\n        return entityFilter!(stateObj);\n      });\n    }\n  }\n\n  let outputAreas = areas.map((area) => ({\n    ...area,\n    picture: area.picture ? joinHassUrl(area.picture) : area.picture,\n  }));\n\n  let areaIds: string[] | undefined;\n\n  if (inputDevices) {\n    areaIds = inputDevices.filter((device) => device.area_id).map((device) => device.area_id!);\n  }\n\n  if (inputEntities) {\n    areaIds = (areaIds ?? []).concat(inputEntities.filter((entity) => entity.area_id).map((entity) => entity.area_id!));\n  }\n\n  if (areaIds) {\n    outputAreas = outputAreas.filter((area) => areaIds!.includes(area.area_id));\n  }\n\n  if (excludeAreas) {\n    outputAreas = outputAreas.filter((area) => !excludeAreas!.includes(area.area_id));\n  }\n\n  if (excludeFloors) {\n    outputAreas = outputAreas.filter((area) => !area.floor_id || !excludeFloors!.includes(area.floor_id));\n  }\n\n  const floorAreaLookup = getFloorAreaLookup(outputAreas);\n  const unassignedAreas = Object.values(outputAreas).filter((area) => !area.floor_id || !floorAreaLookup[area.floor_id]);\n\n  const compare = floorCompare(_floors);\n  // @ts-expect-error - fix later\n  const floorAreaEntries: [FloorRegistryEntry | undefined, AreaRegistryEntry[]][] = Object.entries(floorAreaLookup)\n    .map(([floorId, floorAreas]) => {\n      const floor = floors.find((fl) => fl.floor_id === floorId)!;\n      return [floor, floorAreas] as const;\n    })\n    .sort(([floorA], [floorB]) => compare(floorA.floor_id, floorB.floor_id));\n\n  const items: UseAreasReturn[] = [];\n\n  floorAreaEntries.forEach(([floor, floorAreas]) => {\n    if (floor) {\n      const floorName = computeFloorName(floor);\n\n      const areaSearchLabels = floorAreas\n        .map((area) => {\n          const areaName = computeAreaName(area) || area.area_id;\n          return [area.area_id, areaName, ...area.aliases];\n        })\n        .flat();\n\n      items.push({\n        id: [\"floor\", floor.floor_id].join(\"______\"),\n        type: \"floor\",\n        primary: floorName,\n        floor: floor,\n        icon: floor.icon || undefined,\n        search_labels: [floor.floor_id, floorName, ...floor.aliases, ...areaSearchLabels],\n      });\n    }\n    items.push(\n      ...floorAreas.map((area) => {\n        const areaName = computeAreaName(area) || area.area_id;\n        return {\n          id: [\"area\", area.area_id].join(\"______\"),\n          type: \"area\" as const,\n          primary: areaName,\n          area: area,\n          icon: area.icon || undefined,\n          search_labels: [area.area_id, areaName, ...area.aliases],\n        };\n      }),\n    );\n  });\n\n  items.push(\n    ...unassignedAreas.map((area) => {\n      const areaName = computeAreaName(area) || area.area_id;\n      return {\n        id: [\"area\", area.area_id].join(\"______\"),\n        type: \"area\" as const,\n        primary: areaName,\n        area: area,\n        icon: area.icon || undefined,\n        search_labels: [area.area_id, areaName, ...area.aliases],\n      };\n    }),\n  );\n\n  return items;\n};\n"],"names":["getDeviceEntityDisplayLookup","entities","deviceEntityLookup","entity","floorCompare","entries","order","a","b","floorA","floorB","nameA","nameB","stringCompare","getFloorAreaLookup","areas","floorAreaLookup","area","useAreas","includeDomains","excludeDomains","includeDeviceClasses","deviceFilter","entityFilter","excludeAreas","excludeFloors","joinHassUrl","useHass","_entities","store","_entitiesRegistryDisplay","_devices","_areas","_floors","floors","devices","inputDevices","inputEntities","device","devEntities","computeDomain","stateObj","outputAreas","areaIds","unassignedAreas","compare","floorAreaEntries","floorId","floorAreas","fl","items","floor","floorName","computeFloorName","areaSearchLabels","areaName","computeAreaName"],"mappings":"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"}