{"version":3,"file":"index.js","sources":["../../../../src/hooks/useWeather/index.ts"],"sourcesContent":["import { useCallback, useState, useMemo, useEffect, useRef } from \"react\";\nimport { type EntityName, type FilterByDomain, type WeatherEntity, useHass, useEntity, HassEntityWithService } from \"@core\";\nimport type { Connection } from \"home-assistant-js-websocket\";\nimport { useDebouncedCallback } from \"use-debounce\";\n\nimport { type ModernForecastType, type ForecastEvent, getForecast, subscribeForecast, type Forecast } from \"./helpers\";\n\nexport interface UseWeatherOptions {\n  type: ModernForecastType;\n}\n\nexport interface WeatherEntityExtended extends WeatherEntity {\n  forecast: ForecastEvent | null;\n}\n\nexport type WeatherEntityWithForecast = HassEntityWithService<\"weather\"> & {\n  forecast: Forecast;\n};\n\nexport function useWeather(entityId: FilterByDomain<EntityName, \"weather\">, options?: UseWeatherOptions): WeatherEntityWithForecast {\n  const connection = useHass((state) => state.connection);\n  const _entity = useEntity(entityId);\n  const [error, setError] = useState<string | null>(null);\n  const [forecastEvent, setForecastEvent] = useState<ForecastEvent | null>(null);\n  const _subscribed = useRef<boolean>(false);\n  const _unsubscribe = useRef<void | (() => Promise<void>)>(undefined);\n\n  const { type = \"daily\" } = options || {};\n\n  const subscribeWeatherEvents = useCallback(\n    (entityId: FilterByDomain<EntityName, \"weather\">, type: ModernForecastType) => {\n      const unsubscribe = subscribeForecast(connection as Connection, entityId, type, (streamMessage) => {\n        // If we receive an event after subscription if false, we most likely\n        // have been unmounted and no need to set the state\n        if (!_subscribed.current) return;\n        setForecastEvent(streamMessage);\n      }).catch((err) => {\n        _subscribed.current = false;\n        if (err instanceof Error) {\n          setError(err.message);\n        }\n      });\n      return unsubscribe;\n    },\n    [connection],\n  );\n\n  const debounceSubscribeWeatherEvents = useDebouncedCallback(\n    async (entityId: FilterByDomain<EntityName, \"weather\">, type: ModernForecastType) => {\n      if (_unsubscribe.current) {\n        const unsubscribe = await _unsubscribe.current;\n        if (unsubscribe) unsubscribe();\n        _unsubscribe.current = undefined;\n      }\n      _subscribed.current = true;\n      _unsubscribe.current = await subscribeWeatherEvents(entityId, type);\n    },\n    100,\n    {\n      trailing: true,\n      leading: true,\n    },\n  );\n\n  useEffect(() => {\n    debounceSubscribeWeatherEvents(entityId, type);\n\n    return () => {\n      _subscribed.current = false;\n      if (_unsubscribe.current) {\n        _unsubscribe.current();\n      }\n    };\n  }, [type, debounceSubscribeWeatherEvents, subscribeWeatherEvents, entityId]);\n\n  if (error) {\n    throw error;\n  }\n\n  return useMemo(() => {\n    const forecastData = getForecast(_entity.attributes, forecastEvent);\n    return {\n      ..._entity,\n      forecast: forecastData,\n    };\n  }, [_entity, forecastEvent]);\n}\n"],"names":["useWeather","entityId","options","connection","useHass","state","_entity","useEntity","error","setError","useState","forecastEvent","setForecastEvent","_subscribed","useRef","_unsubscribe","type","subscribeWeatherEvents","useCallback","subscribeForecast","streamMessage","err","debounceSubscribeWeatherEvents","useDebouncedCallback","unsubscribe","useEffect","useMemo","forecastData","getForecast"],"mappings":"4ZAmBO,SAASA,EAAWC,EAAiDC,EAAwD,CAClI,MAAMC,EAAaC,EAAAA,QAASC,GAAUA,EAAM,UAAU,EAChDC,EAAUC,EAAAA,UAAUN,CAAQ,EAC5B,CAACO,EAAOC,CAAQ,EAAIC,EAAAA,SAAwB,IAAI,EAChD,CAACC,EAAeC,CAAgB,EAAIF,EAAAA,SAA+B,IAAI,EACvEG,EAAcC,EAAAA,OAAgB,EAAK,EACnCC,EAAeD,EAAAA,OAAqC,MAAS,EAE7D,CAAE,KAAAE,EAAO,OAAA,EAAYd,GAAW,CAAA,EAEhCe,EAAyBC,EAAAA,YAC7B,CAACjB,EAAiDe,IAC5BG,EAAAA,kBAAkBhB,EAA0BF,EAAUe,EAAOI,GAAkB,CAG5FP,EAAY,SACjBD,EAAiBQ,CAAa,CAChC,CAAC,EAAE,MAAOC,GAAQ,CAChBR,EAAY,QAAU,GAClBQ,aAAe,OACjBZ,EAASY,EAAI,OAAO,CAExB,CAAC,EAGH,CAAClB,CAAU,CAAA,EAGPmB,EAAiCC,EAAAA,qBACrC,MAAOtB,EAAiDe,IAA6B,CACnF,GAAID,EAAa,QAAS,CACxB,MAAMS,EAAc,MAAMT,EAAa,QACnCS,GAAaA,EAAA,EACjBT,EAAa,QAAU,MACzB,CACAF,EAAY,QAAU,GACtBE,EAAa,QAAU,MAAME,EAAuBhB,EAAUe,CAAI,CACpE,EACA,IACA,CACE,SAAU,GACV,QAAS,EAAA,CACX,EAcF,GAXAS,EAAAA,UAAU,KACRH,EAA+BrB,EAAUe,CAAI,EAEtC,IAAM,CACXH,EAAY,QAAU,GAClBE,EAAa,SACfA,EAAa,QAAA,CAEjB,GACC,CAACC,EAAMM,EAAgCL,EAAwBhB,CAAQ,CAAC,EAEvEO,EACF,MAAMA,EAGR,OAAOkB,EAAAA,QAAQ,IAAM,CACnB,MAAMC,EAAeC,EAAAA,YAAYtB,EAAQ,WAAYK,CAAa,EAClE,MAAO,CACL,GAAGL,EACH,SAAUqB,CAAA,CAEd,EAAG,CAACrB,EAASK,CAAa,CAAC,CAC7B"}