{"version":3,"file":"logbook.js","sources":["../../../../src/hooks/useLogs/logbook.ts"],"sourcesContent":["import { HassEntity, Connection, type MessageBase } from \"home-assistant-js-websocket\";\nimport { computeDomain, ON, OFF, UNAVAILABLE, DOMAINS_WITH_DYNAMIC_PICTURE, UNKNOWN, type EntityName, localize } from \"@core\";\nimport { LocaleKeys } from \"../useLocale/locales/types\";\nexport const CONTINUOUS_DOMAINS = [\"counter\", \"proximity\", \"sensor\", \"zone\"];\n\nexport interface LogbookStreamMessage {\n  events: LogbookEntry[];\n  start_time?: number; // Start time of this historical chunk\n  end_time?: number; // End time of this historical chunk\n  partial?: boolean; // indicates more historical chunks are coming\n}\n\nexport interface LogbookEntry {\n  // Base data\n  when: number; // Python timestamp. Do *1000 to get JS timestamp.\n  name: string;\n  message?: string;\n  entity_id?: string;\n  icon?: string;\n  source?: string; // The trigger source\n  domain?: string;\n  state?: string; // The state of the entity\n  // Context data\n  context_id?: string;\n  context_user_id?: string;\n  context_event_type?: string;\n  context_domain?: string;\n  context_service?: string; // Service calls only\n  context_entity_id?: string;\n  context_entity_id_name?: string; // Legacy, not longer sent\n  context_name?: string;\n  context_state?: string; // The state of the entity\n  context_source?: string; // The trigger source\n  context_message?: string;\n}\nexport const createHistoricState = (entity: HassEntity, state?: string): HassEntity => <HassEntity>(<unknown>{\n    entity_id: entity.entity_id,\n    state: state,\n    attributes: {\n      // Rebuild the historical state by copying static attributes only\n      device_class: entity?.attributes.device_class,\n      source_type: entity?.attributes.source_type,\n      has_date: entity?.attributes.has_date,\n      has_time: entity?.attributes.has_time,\n      // We do not want to use dynamic entity pictures (e.g., from media player) for the log book rendering,\n      // as they would present a false state in the log (played media right now vs actual historic data).\n      entity_picture_local: DOMAINS_WITH_DYNAMIC_PICTURE.has(computeDomain(entity.entity_id as EntityName))\n        ? undefined\n        : entity?.attributes.entity_picture_local,\n      entity_picture: DOMAINS_WITH_DYNAMIC_PICTURE.has(computeDomain(entity.entity_id as EntityName))\n        ? undefined\n        : entity?.attributes.entity_picture,\n    },\n  });\n\nexport const subscribeLogbook = (\n  connection: Connection,\n  callbackFunction: (message: LogbookStreamMessage) => void,\n  startDate: string,\n  endDate: string,\n  entityIds?: string[],\n  deviceIds?: string[],\n): Promise<() => Promise<void>> => {\n  // If all specified filters are empty lists, we can return an empty list.\n  if ((entityIds || deviceIds) && (!entityIds || entityIds.length === 0) && (!deviceIds || deviceIds.length === 0)) {\n    return Promise.reject(`${localize(\"no_matching_entities_found\")}, ${localize(\"no_matching_devices_found\")}`);\n  }\n  const params: MessageBase = {\n    type: \"logbook/event_stream\",\n    start_time: startDate,\n    end_time: endDate,\n  };\n  if (entityIds?.length) {\n    params.entity_ids = entityIds;\n  }\n  if (deviceIds?.length) {\n    params.device_ids = deviceIds;\n  }\n  return connection.subscribeMessage<LogbookStreamMessage>((message) => callbackFunction(message), params);\n};\n\nconst triggerPhrases = {\n  \"numeric state of\": \"triggered_by_numeric_state_of\", // number state trigger\n  \"state of\": \"triggered_by_state_of\", // state trigger\n  event: \"triggered_by_event\", // event trigger\n  time: \"triggered_by_time\", // time trigger\n  \"time pattern\": \"triggered_by_time_pattern\", // time trigger\n  \"Home Assistant stopping\": \"triggered_by_home_assistant_stopping\", // stop event\n  \"Home Assistant starting\": \"triggered_by_home_assistant_starting\", // start event\n} satisfies Record<string, LocaleKeys>;\n\nexport const localizeTriggerSource = (source: string) => {\n  for (const triggerPhrase in triggerPhrases) {\n    if (source.startsWith(triggerPhrase)) {\n      return source.replace(\n        triggerPhrase,\n        // @ts-expect-error - this is fine, it'll return undefined\n        `${localize(`${triggerPhrases[triggerPhrase]}`)}`,\n      );\n    }\n  }\n  return source;\n};\n\nexport const localizeStateMessage = (state: string, stateObj: HassEntity, domain: string): string => {\n  switch (domain) {\n    case \"device_tracker\":\n    case \"person\":\n      if (state === \"not_home\") {\n        return localize(\"was_detected_away\");\n      }\n      if (state === \"home\") {\n        return localize(\"was_detected_at_home\");\n      }\n      return localize(`was_detected_at_state`, {\n        search: \"{state}\",\n        replace: state,\n      });\n\n    case \"sun\":\n      return state === \"above_horizon\" ? localize(`rose`) : localize(`set`);\n\n    case \"binary_sensor\": {\n      const isOn = state === ON;\n      const isOff = state === OFF;\n      const device_class = stateObj.attributes.device_class;\n\n      switch (device_class) {\n        case \"battery\":\n          if (isOn) {\n            return localize(`was_low`);\n          }\n          if (isOff) {\n            return localize(`was_normal`);\n          }\n          break;\n\n        case \"connectivity\":\n          if (isOn) {\n            return localize(`was_connected`);\n          }\n          if (isOff) {\n            return localize(`was_disconnected`);\n          }\n          break;\n\n        case \"door\":\n        case \"garage_door\":\n        case \"opening\":\n        case \"window\":\n          if (isOn) {\n            return localize(`was_opened`);\n          }\n          if (isOff) {\n            return localize(`was_closed`);\n          }\n          break;\n\n        case \"lock\":\n          if (isOn) {\n            return localize(`was_unlocked`);\n          }\n          if (isOff) {\n            return localize(`was_locked`);\n          }\n          break;\n\n        case \"plug\":\n          if (isOn) {\n            return localize(`was_plugged_in`);\n          }\n          if (isOff) {\n            return localize(`was_unplugged`);\n          }\n          break;\n\n        case \"presence\":\n          if (isOn) {\n            return localize(`was_detected_at_home`);\n          }\n          if (isOff) {\n            return localize(`was_detected_away`);\n          }\n          break;\n\n        case \"safety\":\n          if (isOn) {\n            return localize(`was_unsafe`);\n          }\n          if (isOff) {\n            return localize(`was_safe`);\n          }\n          break;\n\n        case \"cold\":\n        case \"gas\":\n        case \"heat\":\n        case \"moisture\":\n        case \"motion\":\n        case \"occupancy\":\n        case \"power\":\n        case \"problem\":\n        case \"smoke\":\n        case \"sound\":\n        case \"vibration\":\n          if (isOn) {\n            return localize(`detected_deviceclass`, {\n              search: \"{device_class}\",\n              replace: device_class,\n            });\n          }\n          if (isOff) {\n            return localize(`cleared_no_deviceclass_detected`, {\n              search: \"{device_class}\",\n              replace: device_class,\n            });\n          }\n          break;\n\n        case \"tamper\":\n          if (isOn) {\n            return localize(`detected_tampering`);\n          }\n          if (isOff) {\n            return localize(`cleared_tampering`);\n          }\n          break;\n      }\n\n      break;\n    }\n\n    case \"cover\":\n      switch (state) {\n        case \"open\":\n          return localize(`was_opened`);\n        case \"opening\":\n          return localize(`is_opening`);\n        case \"closing\":\n          return localize(`is_closing`);\n        case \"closed\":\n          return localize(`was_closed`);\n      }\n      break;\n\n    case \"event\": {\n      return localize(`detected_an_event`);\n    }\n\n    case \"lock\":\n      switch (state) {\n        case \"unlocked\":\n          return localize(`was_unlocked`);\n        case \"locking\":\n          return localize(`is_locking`);\n        case \"unlocking\":\n          return localize(`is_unlocking`);\n        case \"locked\":\n          return localize(`was_locked`);\n        case \"jammed\":\n          return localize(`is_jammed`);\n      }\n      break;\n  }\n\n  if (state === ON) {\n    return localize(`turned_on`);\n  }\n\n  if (state === OFF) {\n    return localize(`turned_off`);\n  }\n\n  if (state === UNKNOWN) {\n    return localize(`became_unknown`);\n  }\n\n  if (state === UNAVAILABLE) {\n    return localize(`became_unavailable`);\n  }\n\n  return localize(`changed_to_state`, {\n    search: \"{state}\",\n    replace: stateObj ? stateObj.state : state,\n  });\n};\n"],"names":["CONTINUOUS_DOMAINS","createHistoricState","entity","state","DOMAINS_WITH_DYNAMIC_PICTURE","computeDomain","subscribeLogbook","connection","callbackFunction","startDate","endDate","entityIds","deviceIds","localize","params","message","triggerPhrases","localizeTriggerSource","source","triggerPhrase","localizeStateMessage","stateObj","domain","isOn","ON","isOff","OFF","device_class","UNKNOWN","UNAVAILABLE"],"mappings":"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"}