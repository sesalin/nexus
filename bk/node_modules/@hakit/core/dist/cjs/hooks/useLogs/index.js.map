{"version":3,"file":"index.js","sources":["../../../../src/hooks/useLogs/index.ts"],"sourcesContent":["import { useCallback, useState, useMemo, useEffect, useRef } from \"react\";\nimport { subscribeLogbook, type LogbookStreamMessage, type LogbookEntry } from \"./logbook\";\nimport { type EntityName, useHass } from \"@core\";\nimport type { Connection } from \"home-assistant-js-websocket\";\nimport { useDebouncedCallback } from \"use-debounce\";\n\ninterface LogbookTimePeriod {\n  now: Date;\n  startTime: Date;\n  endTime: Date;\n  purgeBeforePythonTime: number | undefined;\n}\n\nexport interface UseLogOptions {\n  /**The hours to show in the response */\n  hoursToShow?: number;\n  /** The start time of the logbook period */\n  startTime?: Date;\n  /** The end time of the logbook period */\n  endTime?: Date;\n}\ntype RecentTime = {\n  // Seconds\n  recent: number;\n};\ntype TimeRange = { range: [Date, Date] };\ntype Time = TimeRange | RecentTime;\n\nconst DEFAULT_HOURS_TO_SHOW = 24;\n\nconst findStartOfRecentTime = (now: Date, recentTime: number) => new Date(now.getTime() - recentTime * 1000).getTime() / 1000;\n\nexport function useLogs(entityId: EntityName, options?: UseLogOptions): LogbookEntry[] {\n  const [error, setError] = useState<string | undefined>(undefined);\n  const connection = useHass((state) => state.connection);\n  const [entries, setEntries] = useState<LogbookEntry[]>([]);\n  const _entriesRef = useRef<LogbookEntry[]>([]);\n  const _subscribed = useRef<boolean>(false);\n  const _unsubscribe = useRef<void | (() => Promise<void>)>(undefined);\n\n  const time = useMemo(() => {\n    // @ts-expect-error - properties are added manually\n    const time: Time = {};\n    if (options?.hoursToShow) {\n      (time as RecentTime).recent = options.hoursToShow * 60 * 60;\n    } else if (options?.startTime && options?.endTime) {\n      (time as TimeRange).range = [options.startTime, options.endTime];\n    } else {\n      (time as RecentTime).recent = DEFAULT_HOURS_TO_SHOW * 60 * 60;\n    }\n    return time;\n  }, [options]);\n\n  const _calculateLogbookPeriod = useCallback(() => {\n    const now = new Date();\n    if (\"range\" in time) {\n      return <LogbookTimePeriod>{\n        now: now,\n        startTime: time.range[0],\n        endTime: time.range[1],\n        purgeBeforePythonTime: undefined,\n      };\n    }\n    if (\"recent\" in time) {\n      const purgeBeforePythonTime = findStartOfRecentTime(now, time.recent);\n      return <LogbookTimePeriod>{\n        now: now,\n        startTime: new Date(purgeBeforePythonTime * 1000),\n        // end streaming one year from now\n        endTime: new Date(now.getTime() + 86400 * 365 * 1000),\n        purgeBeforePythonTime: findStartOfRecentTime(now, time.recent),\n      };\n    }\n    throw new Error(\"Unexpected time specified\");\n  }, [time]);\n\n  const _nonExpiredRecords = useCallback(\n    (purgeBeforePythonTime: number | undefined) =>\n      !_entriesRef.current\n        ? []\n        : purgeBeforePythonTime\n          ? _entriesRef.current.filter((entry) => entry.when > purgeBeforePythonTime!)\n          : _entriesRef.current,\n    [],\n  );\n\n  const _processStreamMessage = useCallback(\n    (streamMessage: LogbookStreamMessage) => {\n      const purgeBeforePythonTime = time && \"recent\" in time ? findStartOfRecentTime(new Date(), time.recent) : undefined;\n      // Put newest ones on top. Reverse works in-place so\n      // make a copy first.\n      const newEntries = [...streamMessage.events].reverse();\n      if (!_entriesRef.current.length) {\n        _entriesRef.current = newEntries;\n        setEntries(newEntries);\n        return;\n      }\n      if (!newEntries.length) {\n        // Empty messages are still sent to\n        // indicate no more historical events\n        return;\n      }\n      const nonExpiredRecords = _nonExpiredRecords(purgeBeforePythonTime);\n      // Entries are sorted in descending order with newest first.\n      if (!nonExpiredRecords.length) {\n        _entriesRef.current = newEntries;\n        // We have no records left, so we can just replace the list\n        setEntries(newEntries);\n      } else if (\n        newEntries[newEntries.length - 1].when > // oldest new entry\n        nonExpiredRecords[0].when // newest old entry\n      ) {\n        // The new records are newer than the old records\n        // append the old records to the end of the new records\n        _entriesRef.current = newEntries.concat(nonExpiredRecords);\n        setEntries(_entriesRef.current);\n      } else if (\n        nonExpiredRecords[nonExpiredRecords.length - 1].when > // oldest old entry\n        newEntries[0].when // newest new entry\n      ) {\n        _entriesRef.current = nonExpiredRecords.concat(newEntries);\n        // The new records are older than the old records\n        // append the new records to the end of the old records\n        setEntries(_entriesRef.current);\n      } else {\n        _entriesRef.current = nonExpiredRecords.concat(newEntries).sort((a: LogbookEntry, b: LogbookEntry) => b.when - a.when);\n        // The new records are in the middle of the old records\n        // so we need to re-sort them\n        setEntries(_entriesRef.current);\n      }\n    },\n    [time, _nonExpiredRecords],\n  );\n\n  useEffect(() => {\n    return () => {\n      _subscribed.current = false;\n      _entriesRef.current = [];\n      setEntries([]);\n    };\n  }, []);\n\n  const subscribeLogbookPeriod = useCallback(\n    (entityId: EntityName, logbookPeriod: LogbookTimePeriod) => {\n      const unsubscribe = subscribeLogbook(\n        connection as Connection,\n        (streamMessage) => {\n          // \"recent\" means start time is a sliding window\n          // so we need to calculate an expireTime to\n          // purge old events\n          if (!_subscribed.current) {\n            // Message came in before we had a chance to unload\n            return;\n          }\n          _processStreamMessage(streamMessage);\n        },\n        logbookPeriod.startTime.toISOString(),\n        logbookPeriod.endTime.toISOString(),\n        [entityId],\n      ).catch((err) => {\n        _subscribed.current = false;\n        if (err instanceof Error) {\n          setError(err.message);\n        }\n      });\n\n      return unsubscribe;\n    },\n    [connection, _processStreamMessage],\n  );\n\n  const debounceSubscribeLogbookPeriod = useDebouncedCallback(\n    async (entityId: EntityName, logBookPeriod: LogbookTimePeriod) => {\n      if (_unsubscribe.current) {\n        const unsubscribe = await _unsubscribe.current;\n        if (unsubscribe) {\n          await unsubscribe();\n        }\n        _unsubscribe.current = undefined;\n      }\n      _subscribed.current = true;\n      _unsubscribe.current = await subscribeLogbookPeriod(entityId, logBookPeriod);\n    },\n    100,\n    {\n      leading: true,\n      trailing: true,\n    },\n  );\n\n  useEffect(() => {\n    const logBookPeriod = _calculateLogbookPeriod();\n\n    debounceSubscribeLogbookPeriod(entityId, logBookPeriod);\n\n    return () => {\n      _subscribed.current = false;\n      if (_unsubscribe.current) {\n        _unsubscribe.current();\n      }\n    };\n  }, [_calculateLogbookPeriod, debounceSubscribeLogbookPeriod, subscribeLogbookPeriod, entityId]);\n\n  if (error) {\n    throw new Error(error);\n  }\n\n  return useMemo(() => entries, [entries]);\n}\n"],"names":["DEFAULT_HOURS_TO_SHOW","findStartOfRecentTime","now","recentTime","useLogs","entityId","options","error","setError","useState","connection","useHass","state","entries","setEntries","_entriesRef","useRef","_subscribed","_unsubscribe","time","useMemo","_calculateLogbookPeriod","useCallback","purgeBeforePythonTime","_nonExpiredRecords","entry","_processStreamMessage","streamMessage","newEntries","nonExpiredRecords","a","b","useEffect","subscribeLogbookPeriod","logbookPeriod","subscribeLogbook","err","debounceSubscribeLogbookPeriod","useDebouncedCallback","logBookPeriod","unsubscribe"],"mappings":"6WA4BA,MAAMA,EAAwB,GAExBC,EAAwB,CAACC,EAAWC,IAAuB,IAAI,KAAKD,EAAI,QAAA,EAAYC,EAAa,GAAI,EAAE,UAAY,IAElH,SAASC,EAAQC,EAAsBC,EAAyC,CACrF,KAAM,CAACC,EAAOC,CAAQ,EAAIC,EAAAA,SAA6B,MAAS,EAC1DC,EAAaC,EAAAA,QAASC,GAAUA,EAAM,UAAU,EAChD,CAACC,EAASC,CAAU,EAAIL,EAAAA,SAAyB,CAAA,CAAE,EACnDM,EAAcC,EAAAA,OAAuB,EAAE,EACvCC,EAAcD,EAAAA,OAAgB,EAAK,EACnCE,EAAeF,EAAAA,OAAqC,MAAS,EAE7DG,EAAOC,EAAAA,QAAQ,IAAM,CAEzB,MAAMD,EAAa,CAAA,EACnB,OAAIb,GAAS,YACVa,EAAoB,OAASb,EAAQ,YAAc,GAAK,GAChDA,GAAS,WAAaA,GAAS,QACvCa,EAAmB,MAAQ,CAACb,EAAQ,UAAWA,EAAQ,OAAO,EAE9Da,EAAoB,OAASnB,EAAwB,GAAK,GAEtDmB,CACT,EAAG,CAACb,CAAO,CAAC,EAENe,EAA0BC,EAAAA,YAAY,IAAM,CAChD,MAAMpB,MAAU,KAChB,GAAI,UAAWiB,EACb,MAA0B,CACxB,IAAAjB,EACA,UAAWiB,EAAK,MAAM,CAAC,EACvB,QAASA,EAAK,MAAM,CAAC,EACrB,sBAAuB,MAAA,EAG3B,GAAI,WAAYA,EAAM,CACpB,MAAMI,EAAwBtB,EAAsBC,EAAKiB,EAAK,MAAM,EACpE,MAA0B,CACxB,IAAAjB,EACA,UAAW,IAAI,KAAKqB,EAAwB,GAAI,EAEhD,QAAS,IAAI,KAAKrB,EAAI,UAAY,MAAQ,IAAM,GAAI,EACpD,sBAAuBD,EAAsBC,EAAKiB,EAAK,MAAM,CAAA,CAEjE,CACA,MAAM,IAAI,MAAM,2BAA2B,CAC7C,EAAG,CAACA,CAAI,CAAC,EAEHK,EAAqBF,EAAAA,YACxBC,GACER,EAAY,QAETQ,EACER,EAAY,QAAQ,OAAQU,GAAUA,EAAM,KAAOF,CAAsB,EACzER,EAAY,QAHd,CAAA,EAIN,CAAA,CAAC,EAGGW,EAAwBJ,EAAAA,YAC3BK,GAAwC,CACvC,MAAMJ,EAAwBJ,GAAQ,WAAYA,EAAOlB,MAA0B,KAAQkB,EAAK,MAAM,EAAI,OAGpGS,EAAa,CAAC,GAAGD,EAAc,MAAM,EAAE,QAAA,EAC7C,GAAI,CAACZ,EAAY,QAAQ,OAAQ,CAC/BA,EAAY,QAAUa,EACtBd,EAAWc,CAAU,EACrB,MACF,CACA,GAAI,CAACA,EAAW,OAGd,OAEF,MAAMC,EAAoBL,EAAmBD,CAAqB,EAE7DM,EAAkB,OAKrBD,EAAWA,EAAW,OAAS,CAAC,EAAE,KAClCC,EAAkB,CAAC,EAAE,MAIrBd,EAAY,QAAUa,EAAW,OAAOC,CAAiB,EACzDf,EAAWC,EAAY,OAAO,GAE9Bc,EAAkBA,EAAkB,OAAS,CAAC,EAAE,KAChDD,EAAW,CAAC,EAAE,MAEdb,EAAY,QAAUc,EAAkB,OAAOD,CAAU,EAGzDd,EAAWC,EAAY,OAAO,IAE9BA,EAAY,QAAUc,EAAkB,OAAOD,CAAU,EAAE,KAAK,CAACE,EAAiBC,IAAoBA,EAAE,KAAOD,EAAE,IAAI,EAGrHhB,EAAWC,EAAY,OAAO,IAvB9BA,EAAY,QAAUa,EAEtBd,EAAWc,CAAU,EAuBzB,EACA,CAACT,EAAMK,CAAkB,CAAA,EAG3BQ,EAAAA,UAAU,IACD,IAAM,CACXf,EAAY,QAAU,GACtBF,EAAY,QAAU,CAAA,EACtBD,EAAW,CAAA,CAAE,CACf,EACC,CAAA,CAAE,EAEL,MAAMmB,EAAyBX,EAAAA,YAC7B,CAACjB,EAAsB6B,IACDC,EAAAA,iBAClBzB,EACCiB,GAAkB,CAIZV,EAAY,SAIjBS,EAAsBC,CAAa,CACrC,EACAO,EAAc,UAAU,YAAA,EACxBA,EAAc,QAAQ,YAAA,EACtB,CAAC7B,CAAQ,CAAA,EACT,MAAO+B,GAAQ,CACfnB,EAAY,QAAU,GAClBmB,aAAe,OACjB5B,EAAS4B,EAAI,OAAO,CAExB,CAAC,EAIH,CAAC1B,EAAYgB,CAAqB,CAAA,EAG9BW,EAAiCC,EAAAA,qBACrC,MAAOjC,EAAsBkC,IAAqC,CAChE,GAAIrB,EAAa,QAAS,CACxB,MAAMsB,EAAc,MAAMtB,EAAa,QACnCsB,GACF,MAAMA,EAAA,EAERtB,EAAa,QAAU,MACzB,CACAD,EAAY,QAAU,GACtBC,EAAa,QAAU,MAAMe,EAAuB5B,EAAUkC,CAAa,CAC7E,EACA,IACA,CACE,QAAS,GACT,SAAU,EAAA,CACZ,EAgBF,GAbAP,EAAAA,UAAU,IAAM,CACd,MAAMO,EAAgBlB,EAAA,EAEtB,OAAAgB,EAA+BhC,EAAUkC,CAAa,EAE/C,IAAM,CACXtB,EAAY,QAAU,GAClBC,EAAa,SACfA,EAAa,QAAA,CAEjB,CACF,EAAG,CAACG,EAAyBgB,EAAgCJ,EAAwB5B,CAAQ,CAAC,EAE1FE,EACF,MAAM,IAAI,MAAMA,CAAK,EAGvB,OAAOa,UAAQ,IAAMP,EAAS,CAACA,CAAO,CAAC,CACzC"}