{"version":3,"file":"index.js","sources":["../../../../src/hooks/useHistory/index.ts"],"sourcesContent":["import { useEffect, useState, useMemo, useRef } from \"react\";\nimport type { EntityName } from \"@core\";\nimport { useSubscribeEntity } from \"../useSubscribeEntity\";\nimport { useHass } from \"../useHass\";\nimport { subscribeHistory, computeHistory } from \"./history\";\nimport type { TimelineState, EntityHistoryState, HistoryStates } from \"./history\";\nimport { coordinatesMinimalResponseCompressedState } from \"./coordinates\";\n\nexport interface HistoryOptions {\n  /** the number of hours to show\n   * @minimum 0\n   * @default 24\n   * @TJS-type integer\n   */\n  hoursToShow?: number;\n  /** only show significant changes @default true */\n  significantChangesOnly?: boolean;\n  /** minimal response data @default true */\n  minimalResponse?: boolean;\n  /* data limits for coordinates, this squashes the upper or lower limits of the data */\n  limits?: {\n    /**\n     * The minimum value to show\n     * @minimum 0\n     * @TJS-type integer\n     */\n    min?: number;\n    /**\n     * The maximum value to show\n     * @minimum 0\n     * @TJS-type integer\n     */\n    max?: number;\n  };\n  /** disable the history subscription @default false */\n  disable?: boolean;\n  /** force the history to assume the values received in history are numeric */\n  forceNumeric?: boolean;\n  /** split groups by device class */\n  splitDeviceClasses?: boolean;\n}\nexport const useHistory = (entityId: EntityName, options?: HistoryOptions) => {\n  const connection = useHass((state) => state.connection);\n  const subscribed = useRef(false);\n  const getEntity = useSubscribeEntity(entityId);\n  const [historyStates, setHistoryStates] = useState<HistoryStates>({});\n  const [history, setHistory] = useState<{\n    timeline: TimelineState[];\n    entityHistory: EntityHistoryState[];\n    coordinates: number[][];\n    loading: boolean;\n  }>({\n    loading: options?.disable ? false : true,\n    timeline: [],\n    entityHistory: [],\n    coordinates: [],\n  });\n\n  const memoizedOptions = useMemo(() => {\n    return {\n      disable: options?.disable,\n      significantChangesOnly: options?.significantChangesOnly,\n      minimalResponse: options?.minimalResponse,\n      hoursToShow: options?.hoursToShow,\n      limits: options?.limits,\n      forceNumeric: options?.forceNumeric,\n      splitDeviceClasses: options?.splitDeviceClasses,\n    };\n  }, [\n    options?.disable,\n    options?.significantChangesOnly,\n    options?.minimalResponse,\n    options?.hoursToShow,\n    options?.limits,\n    options?.forceNumeric,\n    options?.splitDeviceClasses,\n  ]);\n\n  useEffect(() => {\n    if (!connection || memoizedOptions?.disable) return;\n    let isMounted = true; // To check if the component is still mounted\n    // Create a local variable to hold the unsubscribe function\n    let localUnsubscribe: null | (() => Promise<void>) = null;\n    subscribeHistory({\n      connection: connection,\n      entityIds: [entityId],\n      significantChangesOnly: memoizedOptions?.significantChangesOnly,\n      minimalResponse: memoizedOptions?.minimalResponse,\n      hoursToShow: memoizedOptions?.hoursToShow,\n      callbackFunction: (history) => {\n        if (!isMounted) return;\n        subscribed.current = true;\n        setHistoryStates(history);\n      },\n    })\n      .then((unsubscribe) => {\n        localUnsubscribe = unsubscribe;\n      })\n      .catch(() => {\n        localUnsubscribe?.();\n        subscribed.current = false;\n      });\n    return () => {\n      isMounted = false;\n      localUnsubscribe?.();\n      subscribed.current = false;\n    };\n  }, [entityId, memoizedOptions, connection]);\n\n  useEffect(() => {\n    if (memoizedOptions?.disable) return;\n    if (subscribed.current) {\n      const entity = getEntity(true);\n      if (!entity) return;\n      const computedHistory = computeHistory(entity, historyStates, memoizedOptions.forceNumeric, memoizedOptions?.splitDeviceClasses);\n      const matchedHistory = computedHistory.timeline.filter(({ entity_id }) => entity_id === entityId);\n      const coordinates =\n        coordinatesMinimalResponseCompressedState(\n          historyStates[entityId],\n          memoizedOptions?.hoursToShow ?? 24,\n          500, // viewbox of the svgGraph\n          typeof memoizedOptions?.significantChangesOnly === \"undefined\" || memoizedOptions?.significantChangesOnly === true ? 1 : 2,\n          memoizedOptions?.limits,\n        ) ?? [];\n\n      setHistory({\n        loading: false,\n        timeline: matchedHistory.length > 0 ? matchedHistory[0].data : [],\n        entityHistory: historyStates[entityId],\n        coordinates,\n      });\n    }\n  }, [entityId, memoizedOptions, getEntity, historyStates]);\n\n  return useMemo(() => history, [history]);\n};\n"],"names":["useHistory","entityId","options","connection","useHass","state","subscribed","useRef","getEntity","useSubscribeEntity","historyStates","setHistoryStates","useState","history","setHistory","memoizedOptions","useMemo","useEffect","isMounted","localUnsubscribe","subscribeHistory","unsubscribe","entity","matchedHistory","computeHistory","entity_id","coordinates","coordinatesMinimalResponseCompressedState"],"mappings":"sPAyCaA,EAAa,CAACC,EAAsBC,IAA6B,CAC5E,MAAMC,EAAaC,EAAAA,QAASC,GAAUA,EAAM,UAAU,EAChDC,EAAaC,EAAAA,OAAO,EAAK,EACzBC,EAAYC,EAAAA,mBAAmBR,CAAQ,EACvC,CAACS,EAAeC,CAAgB,EAAIC,EAAAA,SAAwB,CAAA,CAAE,EAC9D,CAACC,EAASC,CAAU,EAAIF,WAK3B,CACD,QAAS,CAAAV,GAAS,QAClB,SAAU,CAAA,EACV,cAAe,CAAA,EACf,YAAa,CAAA,CAAC,CACf,EAEKa,EAAkBC,EAAAA,QAAQ,KACvB,CACL,QAASd,GAAS,QAClB,uBAAwBA,GAAS,uBACjC,gBAAiBA,GAAS,gBAC1B,YAAaA,GAAS,YACtB,OAAQA,GAAS,OACjB,aAAcA,GAAS,aACvB,mBAAoBA,GAAS,kBAAA,GAE9B,CACDA,GAAS,QACTA,GAAS,uBACTA,GAAS,gBACTA,GAAS,YACTA,GAAS,OACTA,GAAS,aACTA,GAAS,kBAAA,CACV,EAEDe,OAAAA,EAAAA,UAAU,IAAM,CACd,GAAI,CAACd,GAAcY,GAAiB,QAAS,OAC7C,IAAIG,EAAY,GAEZC,EAAiD,KACrDC,OAAAA,mBAAiB,CACf,WAAAjB,EACA,UAAW,CAACF,CAAQ,EACpB,uBAAwBc,GAAiB,uBACzC,gBAAiBA,GAAiB,gBAClC,YAAaA,GAAiB,YAC9B,iBAAmBF,GAAY,CACxBK,IACLZ,EAAW,QAAU,GACrBK,EAAiBE,CAAO,EAC1B,CAAA,CACD,EACE,KAAMQ,GAAgB,CACrBF,EAAmBE,CACrB,CAAC,EACA,MAAM,IAAM,CACXF,IAAA,EACAb,EAAW,QAAU,EACvB,CAAC,EACI,IAAM,CACXY,EAAY,GACZC,IAAA,EACAb,EAAW,QAAU,EACvB,CACF,EAAG,CAACL,EAAUc,EAAiBZ,CAAU,CAAC,EAE1Cc,EAAAA,UAAU,IAAM,CACd,GAAI,CAAAF,GAAiB,SACjBT,EAAW,QAAS,CACtB,MAAMgB,EAASd,EAAU,EAAI,EAC7B,GAAI,CAACc,EAAQ,OAEb,MAAMC,EADkBC,EAAAA,eAAeF,EAAQZ,EAAeK,EAAgB,aAAcA,GAAiB,kBAAkB,EACxF,SAAS,OAAO,CAAC,CAAE,UAAAU,CAAA,IAAgBA,IAAcxB,CAAQ,EAC1FyB,EACJC,EAAAA,0CACEjB,EAAcT,CAAQ,EACtBc,GAAiB,aAAe,GAChC,IACA,OAAOA,GAAiB,uBAA2B,KAAeA,GAAiB,yBAA2B,GAAO,EAAI,EACzHA,GAAiB,MAAA,GACd,CAAA,EAEPD,EAAW,CACT,QAAS,GACT,SAAUS,EAAe,OAAS,EAAIA,EAAe,CAAC,EAAE,KAAO,CAAA,EAC/D,cAAeb,EAAcT,CAAQ,EACrC,YAAAyB,CAAA,CACD,CACH,CACF,EAAG,CAACzB,EAAUc,EAAiBP,EAAWE,CAAa,CAAC,EAEjDM,UAAQ,IAAMH,EAAS,CAACA,CAAO,CAAC,CACzC"}