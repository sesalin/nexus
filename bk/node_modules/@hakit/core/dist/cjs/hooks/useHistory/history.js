"use strict";Object.defineProperty(exports,Symbol.toStringTag,{value:"Module"});require("lodash");const h=require("../../../index-Btx17BPO.cjs"),g=require("../../utils/computeDomain.js");require("home-assistant-js-websocket");require("react");require("@iconify/react");require("use-debounce");require("../useLocale/locales/index.js");require("../../utils/date.js");const A=["climate","humidifier","water_heater"],O=["climate","humidifier","input_datetime","water_heater","person","device_tracker"],E=["temperature","current_temperature","target_temp_low","target_temp_high","hvac_action","humidity","mode","action","current_humidity"],k=e=>O.includes(g.computeDomain(e)),q=({connection:e,entityIds:s,callbackFunction:n,hoursToShow:i=24,minimalResponse:t=!0,significantChangesOnly:o=!0,noAttributes:u})=>{const r={type:"history/stream",entity_ids:s,start_time:new Date(new Date().getTime()-3600*i*1e3).toISOString(),minimal_response:t,significant_changes_only:o,no_attributes:u??!s.some(c=>k(c))},f=new C(i);return e.subscribeMessage(c=>n(f.processMessage(c)),r)};class C{hoursToShow;combinedHistory;constructor(s){this.hoursToShow=s,this.combinedHistory={}}processMessage(s){if(!this.combinedHistory||!Object.keys(this.combinedHistory).length)return this.combinedHistory=s.states,this.combinedHistory;if(!Object.keys(s.states).length)return this.combinedHistory;const n=this.hoursToShow?(new Date().getTime()-3600*this.hoursToShow*1e3)/1e3:void 0,i={};for(const t of Object.keys(this.combinedHistory))i[t]=[];for(const t of Object.keys(s.states))i[t]=[];for(const t of Object.keys(i)){if(t in this.combinedHistory&&t in s.states){const o=this.combinedHistory[t],u=o[o.length-1];i[t]=o.concat(s.states[t]),s.states[t][0].lu<u.lu&&(i[t]=i[t].sort((r,f)=>r.lu-f.lu))}else t in this.combinedHistory?i[t]=this.combinedHistory[t]:i[t]=s.states[t];if(n&&t in this.combinedHistory){const o=i[t].filter(r=>r.lu<n);if(!o.length||(i[t]=i[t].filter(r=>r.lu>=n),i[t].length&&i[t][0].lu===n))continue;const u=o[o.length-1];u.lu=n,i[t].unshift(u)}}return this.combinedHistory=i,this.combinedHistory}}const v=(e,s)=>e.state===s.state&&(!e.attributes||!s.attributes||E.every(n=>e.attributes[n]===s.attributes[n])),j=(e,s,n)=>{const i=h.useHass.getState().entities,t=[];return Object.keys(n).forEach(o=>{const u=n[o],r=u[0],f=g.computeDomain(o),c=[];for(const a of u){let l;if(A.includes(f)){l={state:a.s,last_changed:a.lu*1e3,attributes:{}};for(const m of E)m in a.a&&(l.attributes[m]=a.a[m])}else l={state:a.s,last_changed:(a.lc?a.lc:a.lu)*1e3,attributes:{}};c.length>1&&v(l,c[c.length-1])&&v(l,c[c.length-2])||c.push(l)}const S=o in i?i[o].attributes:"friendly_name"in r.a?r.a:void 0;t.push({domain:f,name:h.computeStateNameFromEntityAttributes(o,S||{}),entity_id:o,states:c})}),{unit:e,device_class:s,identifier:Object.keys(n).join(""),data:t}},U=(e,s,n)=>{const i=[],t=s[0],o=h.useHass.getState().formatter,u=h.useHass.getState().entities;for(const r of s){if(i.length>0&&r.s===i[i.length-1].state)continue;const f={};n?.attributes.device_class&&(f.device_class=n?.attributes.device_class);const c=u[e];i.push({state_localize:o.attributeValue({...c,attributes:{...r.a||t.a,...f}},r.s),state:r.s,last_changed:(r.lc?r.lc:r.lu)*1e3})}return{name:h.computeStateNameFromEntityAttributes(e,n?.attributes||t.a),entity_id:e,data:i}},F=["counter","input_number","number"],D=e=>F.includes(e),T=e=>"unit_of_measurement"in e||"state_class"in e,L=(e,s)=>e.attributes.device_class!=null&&s.includes(e.attributes.device_class),z=(e,s,n,i,t=!1)=>t||D(e)||s!=null&&T(s.attributes)||s!=null&&e==="sensor"&&L(s,i)||n!=null,B=" ",K=(e,s,n)=>n?`${e}_${s||""}`:e,P=(e,s,n=!1,i=!1)=>{const t={},o=[],u={},r=h.useHass.getState().sensorNumericDeviceClasses,f=h.useHass.getState().config,c=h.useHass.getState().entities;return e.entity_id in s?u[e.entity_id]=s[e.entity_id]:c[e.entity_id]&&(u[e.entity_id]=[{s:c[e.entity_id].state,a:c[e.entity_id].attributes,lu:new Date(c[e.entity_id].last_updated).getTime()/1e3}]),u?(Object.keys(s).forEach(a=>{const l=u[a];if(l.length===0)return;const m=g.computeDomain(a),d=a in c?c[a]:void 0,p=d||D(m)?void 0:l.find(H=>H.a&&T(H.a)),N=z(m,d,p,r,n);let b;N?b=d?.attributes.unit_of_measurement||p?.a.unit_of_measurement||B:m==="zone"?b=h.localize("people_in_zone"):m==="climate"||m==="water_heater"?b=f?.unit_system.temperature:m==="humidifier"&&(b="%");let y;m==="climate"?y="temperature":m==="humidifier"?y="humidity":m==="water_heater"&&(y="temperature");const w=y||(d?.attributes||p?.a)?.device_class,_=K(b,w,i);b?_&&_ in t&&a in t[_]?t[_][a].push(...l):_&&(_ in t||(t[_]={}),t[_][a]=l):o.push(U(a,l,d))}),{line:Object.keys(t).map(a=>{const l=a.split("_"),m=l[0],d=l.slice(1).join("_")||void 0;return j(m,d,t[a])}),timeline:o}):{line:[],timeline:[]}};exports.computeHistory=P;exports.subscribeHistory=q;
//# sourceMappingURL=history.js.map
