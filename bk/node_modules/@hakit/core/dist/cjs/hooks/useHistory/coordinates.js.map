{"version":3,"file":"coordinates.js","sources":["../../../../src/hooks/useHistory/coordinates.ts"],"sourcesContent":["/* eslint-disable @typescript-eslint/no-explicit-any */\nimport type { EntityHistoryState } from \"./history\";\nconst STROKE_WIDTH = 5;\nconst average = (items: any[]): number => items.reduce((sum, entry) => sum + parseFloat(entry.state), 0) / items.length;\n\nconst lastValue = (items: any[]): number => parseFloat(items[items.length - 1].state) || 0;\n\nconst calcPoints = (history: any, hours: number, width: number, detail: number, min: number, max: number): number[][] => {\n  const coords = [] as number[][];\n  const height = 80;\n  let yRatio = (max - min) / height;\n  yRatio = yRatio !== 0 ? yRatio : height;\n  let xRatio = width / (hours - (detail === 1 ? 1 : 0));\n  xRatio = isFinite(xRatio) ? xRatio : width;\n\n  const first = history.filter(Boolean)[0];\n  let last = [average(first), lastValue(first)];\n\n  const getCoords = (item: any[], i: number, offset = 0, depth = 1): void => {\n    if (depth > 1 && item) {\n      return item.forEach((subItem, index) => getCoords(subItem, i, index, depth - 1));\n    }\n\n    const x = xRatio * (i + offset / 6);\n\n    if (item) {\n      last = [average(item), lastValue(item)];\n    }\n    const y = height + STROKE_WIDTH / 2 - ((item ? last[0] : last[1]) - min) / yRatio;\n    // @ts-expect-error - bad types FROM HOME ASSISTANT\n    return coords.push([x, y]);\n  };\n\n  for (let i = 0; i < history.length; i += 1) {\n    getCoords(history[i], i, 0, detail);\n  }\n\n  if (coords.length === 1) {\n    coords[1] = [width, coords[0][1]];\n  }\n\n  coords.push([width, coords[coords.length - 1][1]]);\n  return coords;\n};\n\ntype AccumulatorType = { [key: number]: NumericEntityHistoryState[] };\n\nexport const coordinates = (\n  history: NumericEntityHistoryState[],\n  hours: number,\n  width: number,\n  detail: number,\n  limits?: { min?: number; max?: number },\n): number[][] | undefined => {\n  history.forEach((item) => {\n    item.state = Number(item.state);\n  });\n  if (history.every((item) => Number.isNaN(item.state))) {\n    history = history.map((item, index) => {\n      if (Number.isNaN(item.state)) {\n        return {\n          ...item,\n          state: index,\n        };\n      }\n      return item;\n    });\n  }\n  history = history.filter((item) => !Number.isNaN(item.state));\n\n  const min = limits?.min !== undefined ? limits.min : Math.min(...history.map((item) => item.state));\n  const max = limits?.max !== undefined ? limits.max : Math.max(...history.map((item) => item.state));\n  const now = new Date().getTime();\n\n  const reduce = (res: NumericEntityHistoryState[][], item: NumericEntityHistoryState, point: boolean): AccumulatorType => {\n    const age = now - new Date(item.last_changed).getTime();\n\n    let key = Math.abs(age / (1000 * 3600) - hours);\n    if (point) {\n      key = (key - Math.floor(key)) * 60;\n      key = Number((Math.round(key / 10) * 10).toString()[0]);\n    } else {\n      key = Math.floor(key);\n    }\n    if (!res[key]) {\n      res[key] = [];\n    }\n    res[key].push(item);\n    return res;\n  };\n  // @ts-expect-error - bad typing, fix later\n  history = history.reduce<NumericEntityHistoryState[][]>(\n    // @ts-expect-error - bad typing, fix later\n    (res, item) => reduce(res, item, false),\n    [],\n  );\n  if (detail > 1) {\n    history = history.map((entry) =>\n      // @ts-expect-error - bad typing, fix later\n      entry.reduce((res, item) => reduce(res, item, true), []),\n    );\n  }\n  if (!history.length) {\n    return undefined;\n  }\n\n  return calcPoints(history, hours, width, detail, min, max);\n};\n\nexport interface NumericEntityHistoryState {\n  state: number;\n  _state: string;\n  last_changed: number;\n}\n\nexport const coordinatesMinimalResponseCompressedState = (\n  history: EntityHistoryState[],\n  hours: number,\n  width: number,\n  detail: number,\n  limits?: { min?: number; max?: number },\n): number[][] | undefined => {\n  if (!history) {\n    return undefined;\n  }\n  const numericHistory: NumericEntityHistoryState[] = history.map((item) => ({\n    _state: item.s,\n    state: Number(item.s),\n    // With minimal response and compressed state, we don't have last_changed,\n    // so we use last_updated since its always the same as last_changed since\n    // we already filtered out states that are the same.\n    last_changed: item.lu * 1000,\n  }));\n  return coordinates(numericHistory, hours, width, detail, limits);\n};\n"],"names":["STROKE_WIDTH","average","items","sum","entry","lastValue","calcPoints","history","hours","width","detail","min","max","coords","yRatio","xRatio","first","last","getCoords","item","i","offset","depth","subItem","index","x","y","coordinates","limits","now","reduce","res","point","age","key","coordinatesMinimalResponseCompressedState","numericHistory"],"mappings":"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"}