"use strict";Object.defineProperty(exports,Symbol.toStringTag,{value:"Module"});require("lodash");const R=require("../../../index-Btx17BPO.cjs"),e=require("react");require("../useLocale/locales/index.js");const W=require("../../utils/supports-feature.js");require("home-assistant-js-websocket");const j=require("../../../index-BbHaMI6d.cjs");require("@iconify/react");require("use-debounce");const l=require("./constants.js");require("../../utils/date.js");const M=require("../../data/entity.js"),y=require("./camera.js");function w(T,s){const t=j.useEntity(T),{joinHassUrl:n}=R.useHass.getState().helpers,a=R.useHass(r=>r.connection),f=e.useRef(!1),d=e.useRef(!1),[h,A]=e.useState(void 0),[S,v]=e.useState(void 0),[i,k]=e.useState(void 0),[E,x]=e.useState(void 0),[g,m]=e.useState(s?.stream!==!1),[p,_]=e.useState(s?.poster!==!1),C=e.useMemo(()=>n(y.computeMJPEGStreamUrl(t)),[t,n]),[u,L]=e.useState({frontend_stream_types:[]}),o=e.useCallback(async()=>{if(s?.poster!==!1&&a&&!M.isUnavailableState(t.state)&&!d.current){d.current=!0,_(!0);try{const r=Math.ceil((s?.imageWidth??l.MAX_IMAGE_WIDTH)*devicePixelRatio),U=Math.ceil(r*(s?.aspectRatio??l.ASPECT_RATIO_DEFAULT)),q=await y.fetchThumbnailUrlWithCache(a,t.entity_id,r,U);A(n(q)),_(!1)}catch(r){_(!1),r instanceof Error&&x(r)}}},[t.entity_id,n,t.state,a,s?.poster,s?.aspectRatio,s?.imageWidth]),b=e.useCallback(async()=>a?.sendMessagePromise({type:"camera/capabilities",entity_id:t.entity_id}),[a,t.entity_id]);e.useEffect(()=>{async function r(){L(await b()||{frontend_stream_types:[]})}r()},[b]);const c=e.useCallback(async()=>{if(s?.stream!==!1&&a&&!M.isUnavailableState(t.state)&&!f.current){f.current=!0,m(!0);try{const r=await y.fetchStreamUrl(a,t.entity_id);v(n(r)),m(!1)}catch(r){m(!1),console.error(r),r instanceof Error&&k(r)}}},[t.entity_id,n,t.state,a,s?.stream]),P=e.useCallback(()=>i||!W.supportsFeatureFromAttributes(t.attributes,l.CAMERA_SUPPORT_STREAM)?!0:u.frontend_stream_types.includes(l.STREAM_TYPE_WEB_RTC)?typeof RTCPeerConnection>"u":!1,[t.attributes,u,i]);return e.useEffect(()=>{c(),o()},[c,o]),e.useMemo(()=>({...t,stream:{url:S,loading:g,error:i,refresh:async()=>(f.current=!1,c())},poster:{url:h,loading:p,error:E,refresh:async()=>(d.current=!1,o())},mjpeg:{url:C,shouldRenderMJPEG:P()},...u}),[t,S,P,g,i,c,h,p,E,C,o,u])}exports.useCamera=w;
//# sourceMappingURL=index.js.map
