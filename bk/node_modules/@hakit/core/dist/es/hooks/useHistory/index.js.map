{"version":3,"file":"index.js","sources":["../../../../src/hooks/useHistory/index.ts"],"sourcesContent":["import { useEffect, useState, useMemo, useRef } from \"react\";\nimport type { EntityName } from \"@core\";\nimport { useSubscribeEntity } from \"../useSubscribeEntity\";\nimport { useHass } from \"../useHass\";\nimport { subscribeHistory, computeHistory } from \"./history\";\nimport type { TimelineState, EntityHistoryState, HistoryStates } from \"./history\";\nimport { coordinatesMinimalResponseCompressedState } from \"./coordinates\";\n\nexport interface HistoryOptions {\n  /** the number of hours to show\n   * @minimum 0\n   * @default 24\n   * @TJS-type integer\n   */\n  hoursToShow?: number;\n  /** only show significant changes @default true */\n  significantChangesOnly?: boolean;\n  /** minimal response data @default true */\n  minimalResponse?: boolean;\n  /* data limits for coordinates, this squashes the upper or lower limits of the data */\n  limits?: {\n    /**\n     * The minimum value to show\n     * @minimum 0\n     * @TJS-type integer\n     */\n    min?: number;\n    /**\n     * The maximum value to show\n     * @minimum 0\n     * @TJS-type integer\n     */\n    max?: number;\n  };\n  /** disable the history subscription @default false */\n  disable?: boolean;\n  /** force the history to assume the values received in history are numeric */\n  forceNumeric?: boolean;\n  /** split groups by device class */\n  splitDeviceClasses?: boolean;\n}\nexport const useHistory = (entityId: EntityName, options?: HistoryOptions) => {\n  const connection = useHass((state) => state.connection);\n  const subscribed = useRef(false);\n  const getEntity = useSubscribeEntity(entityId);\n  const [historyStates, setHistoryStates] = useState<HistoryStates>({});\n  const [history, setHistory] = useState<{\n    timeline: TimelineState[];\n    entityHistory: EntityHistoryState[];\n    coordinates: number[][];\n    loading: boolean;\n  }>({\n    loading: options?.disable ? false : true,\n    timeline: [],\n    entityHistory: [],\n    coordinates: [],\n  });\n\n  const memoizedOptions = useMemo(() => {\n    return {\n      disable: options?.disable,\n      significantChangesOnly: options?.significantChangesOnly,\n      minimalResponse: options?.minimalResponse,\n      hoursToShow: options?.hoursToShow,\n      limits: options?.limits,\n      forceNumeric: options?.forceNumeric,\n      splitDeviceClasses: options?.splitDeviceClasses,\n    };\n  }, [\n    options?.disable,\n    options?.significantChangesOnly,\n    options?.minimalResponse,\n    options?.hoursToShow,\n    options?.limits,\n    options?.forceNumeric,\n    options?.splitDeviceClasses,\n  ]);\n\n  useEffect(() => {\n    if (!connection || memoizedOptions?.disable) return;\n    let isMounted = true; // To check if the component is still mounted\n    // Create a local variable to hold the unsubscribe function\n    let localUnsubscribe: null | (() => Promise<void>) = null;\n    subscribeHistory({\n      connection: connection,\n      entityIds: [entityId],\n      significantChangesOnly: memoizedOptions?.significantChangesOnly,\n      minimalResponse: memoizedOptions?.minimalResponse,\n      hoursToShow: memoizedOptions?.hoursToShow,\n      callbackFunction: (history) => {\n        if (!isMounted) return;\n        subscribed.current = true;\n        setHistoryStates(history);\n      },\n    })\n      .then((unsubscribe) => {\n        localUnsubscribe = unsubscribe;\n      })\n      .catch(() => {\n        localUnsubscribe?.();\n        subscribed.current = false;\n      });\n    return () => {\n      isMounted = false;\n      localUnsubscribe?.();\n      subscribed.current = false;\n    };\n  }, [entityId, memoizedOptions, connection]);\n\n  useEffect(() => {\n    if (memoizedOptions?.disable) return;\n    if (subscribed.current) {\n      const entity = getEntity(true);\n      if (!entity) return;\n      const computedHistory = computeHistory(entity, historyStates, memoizedOptions.forceNumeric, memoizedOptions?.splitDeviceClasses);\n      const matchedHistory = computedHistory.timeline.filter(({ entity_id }) => entity_id === entityId);\n      const coordinates =\n        coordinatesMinimalResponseCompressedState(\n          historyStates[entityId],\n          memoizedOptions?.hoursToShow ?? 24,\n          500, // viewbox of the svgGraph\n          typeof memoizedOptions?.significantChangesOnly === \"undefined\" || memoizedOptions?.significantChangesOnly === true ? 1 : 2,\n          memoizedOptions?.limits,\n        ) ?? [];\n\n      setHistory({\n        loading: false,\n        timeline: matchedHistory.length > 0 ? matchedHistory[0].data : [],\n        entityHistory: historyStates[entityId],\n        coordinates,\n      });\n    }\n  }, [entityId, memoizedOptions, getEntity, historyStates]);\n\n  return useMemo(() => history, [history]);\n};\n"],"names":["useHistory","entityId","options","connection","useHass","state","subscribed","useRef","getEntity","useSubscribeEntity","historyStates","setHistoryStates","useState","history","setHistory","memoizedOptions","useMemo","useEffect","isMounted","localUnsubscribe","subscribeHistory","unsubscribe","entity","matchedHistory","computeHistory","entity_id","coordinates","coordinatesMinimalResponseCompressedState"],"mappings":";;;;;AAyCO,MAAMA,IAAa,CAACC,GAAsBC,MAA6B;AAC5E,QAAMC,IAAaC,EAAQ,CAACC,MAAUA,EAAM,UAAU,GAChDC,IAAaC,EAAO,EAAK,GACzBC,IAAYC,EAAmBR,CAAQ,GACvC,CAACS,GAAeC,CAAgB,IAAIC,EAAwB,CAAA,CAAE,GAC9D,CAACC,GAASC,CAAU,IAAIF,EAK3B;AAAA,IACD,SAAS,CAAAV,GAAS;AAAA,IAClB,UAAU,CAAA;AAAA,IACV,eAAe,CAAA;AAAA,IACf,aAAa,CAAA;AAAA,EAAC,CACf,GAEKa,IAAkBC,EAAQ,OACvB;AAAA,IACL,SAASd,GAAS;AAAA,IAClB,wBAAwBA,GAAS;AAAA,IACjC,iBAAiBA,GAAS;AAAA,IAC1B,aAAaA,GAAS;AAAA,IACtB,QAAQA,GAAS;AAAA,IACjB,cAAcA,GAAS;AAAA,IACvB,oBAAoBA,GAAS;AAAA,EAAA,IAE9B;AAAA,IACDA,GAAS;AAAA,IACTA,GAAS;AAAA,IACTA,GAAS;AAAA,IACTA,GAAS;AAAA,IACTA,GAAS;AAAA,IACTA,GAAS;AAAA,IACTA,GAAS;AAAA,EAAA,CACV;AAED,SAAAe,EAAU,MAAM;AACd,QAAI,CAACd,KAAcY,GAAiB,QAAS;AAC7C,QAAIG,IAAY,IAEZC,IAAiD;AACrD,WAAAC,EAAiB;AAAA,MACf,YAAAjB;AAAA,MACA,WAAW,CAACF,CAAQ;AAAA,MACpB,wBAAwBc,GAAiB;AAAA,MACzC,iBAAiBA,GAAiB;AAAA,MAClC,aAAaA,GAAiB;AAAA,MAC9B,kBAAkB,CAACF,MAAY;AAC7B,QAAKK,MACLZ,EAAW,UAAU,IACrBK,EAAiBE,CAAO;AAAA,MAC1B;AAAA,IAAA,CACD,EACE,KAAK,CAACQ,MAAgB;AACrB,MAAAF,IAAmBE;AAAA,IACrB,CAAC,EACA,MAAM,MAAM;AACX,MAAAF,IAAA,GACAb,EAAW,UAAU;AAAA,IACvB,CAAC,GACI,MAAM;AACX,MAAAY,IAAY,IACZC,IAAA,GACAb,EAAW,UAAU;AAAA,IACvB;AAAA,EACF,GAAG,CAACL,GAAUc,GAAiBZ,CAAU,CAAC,GAE1Cc,EAAU,MAAM;AACd,QAAI,CAAAF,GAAiB,WACjBT,EAAW,SAAS;AACtB,YAAMgB,IAASd,EAAU,EAAI;AAC7B,UAAI,CAACc,EAAQ;AAEb,YAAMC,IADkBC,EAAeF,GAAQZ,GAAeK,EAAgB,cAAcA,GAAiB,kBAAkB,EACxF,SAAS,OAAO,CAAC,EAAE,WAAAU,EAAA,MAAgBA,MAAcxB,CAAQ,GAC1FyB,IACJC;AAAA,QACEjB,EAAcT,CAAQ;AAAA,QACtBc,GAAiB,eAAe;AAAA,QAChC;AAAA;AAAA,QACA,OAAOA,GAAiB,yBAA2B,OAAeA,GAAiB,2BAA2B,KAAO,IAAI;AAAA,QACzHA,GAAiB;AAAA,MAAA,KACd,CAAA;AAEP,MAAAD,EAAW;AAAA,QACT,SAAS;AAAA,QACT,UAAUS,EAAe,SAAS,IAAIA,EAAe,CAAC,EAAE,OAAO,CAAA;AAAA,QAC/D,eAAeb,EAAcT,CAAQ;AAAA,QACrC,aAAAyB;AAAA,MAAA,CACD;AAAA,IACH;AAAA,EACF,GAAG,CAACzB,GAAUc,GAAiBP,GAAWE,CAAa,CAAC,GAEjDM,EAAQ,MAAMH,GAAS,CAACA,CAAO,CAAC;AACzC;"}