{"version":3,"file":"logbook.js","sources":["../../../../src/hooks/useLogs/logbook.ts"],"sourcesContent":["import { HassEntity, Connection, type MessageBase } from \"home-assistant-js-websocket\";\nimport { computeDomain, ON, OFF, UNAVAILABLE, DOMAINS_WITH_DYNAMIC_PICTURE, UNKNOWN, type EntityName, localize } from \"@core\";\nimport { LocaleKeys } from \"../useLocale/locales/types\";\nexport const CONTINUOUS_DOMAINS = [\"counter\", \"proximity\", \"sensor\", \"zone\"];\n\nexport interface LogbookStreamMessage {\n  events: LogbookEntry[];\n  start_time?: number; // Start time of this historical chunk\n  end_time?: number; // End time of this historical chunk\n  partial?: boolean; // indicates more historical chunks are coming\n}\n\nexport interface LogbookEntry {\n  // Base data\n  when: number; // Python timestamp. Do *1000 to get JS timestamp.\n  name: string;\n  message?: string;\n  entity_id?: string;\n  icon?: string;\n  source?: string; // The trigger source\n  domain?: string;\n  state?: string; // The state of the entity\n  // Context data\n  context_id?: string;\n  context_user_id?: string;\n  context_event_type?: string;\n  context_domain?: string;\n  context_service?: string; // Service calls only\n  context_entity_id?: string;\n  context_entity_id_name?: string; // Legacy, not longer sent\n  context_name?: string;\n  context_state?: string; // The state of the entity\n  context_source?: string; // The trigger source\n  context_message?: string;\n}\nexport const createHistoricState = (entity: HassEntity, state?: string): HassEntity => <HassEntity>(<unknown>{\n    entity_id: entity.entity_id,\n    state: state,\n    attributes: {\n      // Rebuild the historical state by copying static attributes only\n      device_class: entity?.attributes.device_class,\n      source_type: entity?.attributes.source_type,\n      has_date: entity?.attributes.has_date,\n      has_time: entity?.attributes.has_time,\n      // We do not want to use dynamic entity pictures (e.g., from media player) for the log book rendering,\n      // as they would present a false state in the log (played media right now vs actual historic data).\n      entity_picture_local: DOMAINS_WITH_DYNAMIC_PICTURE.has(computeDomain(entity.entity_id as EntityName))\n        ? undefined\n        : entity?.attributes.entity_picture_local,\n      entity_picture: DOMAINS_WITH_DYNAMIC_PICTURE.has(computeDomain(entity.entity_id as EntityName))\n        ? undefined\n        : entity?.attributes.entity_picture,\n    },\n  });\n\nexport const subscribeLogbook = (\n  connection: Connection,\n  callbackFunction: (message: LogbookStreamMessage) => void,\n  startDate: string,\n  endDate: string,\n  entityIds?: string[],\n  deviceIds?: string[],\n): Promise<() => Promise<void>> => {\n  // If all specified filters are empty lists, we can return an empty list.\n  if ((entityIds || deviceIds) && (!entityIds || entityIds.length === 0) && (!deviceIds || deviceIds.length === 0)) {\n    return Promise.reject(`${localize(\"no_matching_entities_found\")}, ${localize(\"no_matching_devices_found\")}`);\n  }\n  const params: MessageBase = {\n    type: \"logbook/event_stream\",\n    start_time: startDate,\n    end_time: endDate,\n  };\n  if (entityIds?.length) {\n    params.entity_ids = entityIds;\n  }\n  if (deviceIds?.length) {\n    params.device_ids = deviceIds;\n  }\n  return connection.subscribeMessage<LogbookStreamMessage>((message) => callbackFunction(message), params);\n};\n\nconst triggerPhrases = {\n  \"numeric state of\": \"triggered_by_numeric_state_of\", // number state trigger\n  \"state of\": \"triggered_by_state_of\", // state trigger\n  event: \"triggered_by_event\", // event trigger\n  time: \"triggered_by_time\", // time trigger\n  \"time pattern\": \"triggered_by_time_pattern\", // time trigger\n  \"Home Assistant stopping\": \"triggered_by_home_assistant_stopping\", // stop event\n  \"Home Assistant starting\": \"triggered_by_home_assistant_starting\", // start event\n} satisfies Record<string, LocaleKeys>;\n\nexport const localizeTriggerSource = (source: string) => {\n  for (const triggerPhrase in triggerPhrases) {\n    if (source.startsWith(triggerPhrase)) {\n      return source.replace(\n        triggerPhrase,\n        // @ts-expect-error - this is fine, it'll return undefined\n        `${localize(`${triggerPhrases[triggerPhrase]}`)}`,\n      );\n    }\n  }\n  return source;\n};\n\nexport const localizeStateMessage = (state: string, stateObj: HassEntity, domain: string): string => {\n  switch (domain) {\n    case \"device_tracker\":\n    case \"person\":\n      if (state === \"not_home\") {\n        return localize(\"was_detected_away\");\n      }\n      if (state === \"home\") {\n        return localize(\"was_detected_at_home\");\n      }\n      return localize(`was_detected_at_state`, {\n        search: \"{state}\",\n        replace: state,\n      });\n\n    case \"sun\":\n      return state === \"above_horizon\" ? localize(`rose`) : localize(`set`);\n\n    case \"binary_sensor\": {\n      const isOn = state === ON;\n      const isOff = state === OFF;\n      const device_class = stateObj.attributes.device_class;\n\n      switch (device_class) {\n        case \"battery\":\n          if (isOn) {\n            return localize(`was_low`);\n          }\n          if (isOff) {\n            return localize(`was_normal`);\n          }\n          break;\n\n        case \"connectivity\":\n          if (isOn) {\n            return localize(`was_connected`);\n          }\n          if (isOff) {\n            return localize(`was_disconnected`);\n          }\n          break;\n\n        case \"door\":\n        case \"garage_door\":\n        case \"opening\":\n        case \"window\":\n          if (isOn) {\n            return localize(`was_opened`);\n          }\n          if (isOff) {\n            return localize(`was_closed`);\n          }\n          break;\n\n        case \"lock\":\n          if (isOn) {\n            return localize(`was_unlocked`);\n          }\n          if (isOff) {\n            return localize(`was_locked`);\n          }\n          break;\n\n        case \"plug\":\n          if (isOn) {\n            return localize(`was_plugged_in`);\n          }\n          if (isOff) {\n            return localize(`was_unplugged`);\n          }\n          break;\n\n        case \"presence\":\n          if (isOn) {\n            return localize(`was_detected_at_home`);\n          }\n          if (isOff) {\n            return localize(`was_detected_away`);\n          }\n          break;\n\n        case \"safety\":\n          if (isOn) {\n            return localize(`was_unsafe`);\n          }\n          if (isOff) {\n            return localize(`was_safe`);\n          }\n          break;\n\n        case \"cold\":\n        case \"gas\":\n        case \"heat\":\n        case \"moisture\":\n        case \"motion\":\n        case \"occupancy\":\n        case \"power\":\n        case \"problem\":\n        case \"smoke\":\n        case \"sound\":\n        case \"vibration\":\n          if (isOn) {\n            return localize(`detected_deviceclass`, {\n              search: \"{device_class}\",\n              replace: device_class,\n            });\n          }\n          if (isOff) {\n            return localize(`cleared_no_deviceclass_detected`, {\n              search: \"{device_class}\",\n              replace: device_class,\n            });\n          }\n          break;\n\n        case \"tamper\":\n          if (isOn) {\n            return localize(`detected_tampering`);\n          }\n          if (isOff) {\n            return localize(`cleared_tampering`);\n          }\n          break;\n      }\n\n      break;\n    }\n\n    case \"cover\":\n      switch (state) {\n        case \"open\":\n          return localize(`was_opened`);\n        case \"opening\":\n          return localize(`is_opening`);\n        case \"closing\":\n          return localize(`is_closing`);\n        case \"closed\":\n          return localize(`was_closed`);\n      }\n      break;\n\n    case \"event\": {\n      return localize(`detected_an_event`);\n    }\n\n    case \"lock\":\n      switch (state) {\n        case \"unlocked\":\n          return localize(`was_unlocked`);\n        case \"locking\":\n          return localize(`is_locking`);\n        case \"unlocking\":\n          return localize(`is_unlocking`);\n        case \"locked\":\n          return localize(`was_locked`);\n        case \"jammed\":\n          return localize(`is_jammed`);\n      }\n      break;\n  }\n\n  if (state === ON) {\n    return localize(`turned_on`);\n  }\n\n  if (state === OFF) {\n    return localize(`turned_off`);\n  }\n\n  if (state === UNKNOWN) {\n    return localize(`became_unknown`);\n  }\n\n  if (state === UNAVAILABLE) {\n    return localize(`became_unavailable`);\n  }\n\n  return localize(`changed_to_state`, {\n    search: \"{state}\",\n    replace: stateObj ? stateObj.state : state,\n  });\n};\n"],"names":["CONTINUOUS_DOMAINS","createHistoricState","entity","state","DOMAINS_WITH_DYNAMIC_PICTURE","computeDomain","subscribeLogbook","connection","callbackFunction","startDate","endDate","entityIds","deviceIds","localize","params","message","triggerPhrases","localizeTriggerSource","source","triggerPhrase","localizeStateMessage","stateObj","domain","isOn","ON","isOff","OFF","device_class","UNKNOWN","UNAVAILABLE"],"mappings":"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"}