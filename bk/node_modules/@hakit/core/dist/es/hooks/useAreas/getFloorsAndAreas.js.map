{"version":3,"file":"getFloorsAndAreas.js","sources":["../../../../src/hooks/useAreas/getFloorsAndAreas.ts"],"sourcesContent":["import {\n  computeDomain,\n  computeAreaName,\n  computeFloorName,\n  type DeviceRegistryEntry,\n  type AreaRegistryEntry,\n  type FloorRegistryEntry,\n  type EntityListInfoCommon,\n  stringCompare,\n  EntityName,\n  type EntityRegistryDisplayEntry,\n  useHass,\n} from \"@core\";\nimport { type HassEntity } from \"home-assistant-js-websocket\";\n\nexport interface UseAreasReturn extends EntityListInfoCommon {\n  type: \"floor\" | \"area\";\n  floor?: FloorRegistryEntry;\n  area?: AreaRegistryEntry;\n}\n\ntype DeviceEntityDisplayLookup = Record<string, EntityRegistryDisplayEntry[]>;\n\nconst getDeviceEntityDisplayLookup = (entities: EntityRegistryDisplayEntry[]): DeviceEntityDisplayLookup => {\n  const deviceEntityLookup: DeviceEntityDisplayLookup = {};\n  for (const entity of entities) {\n    if (!entity.device_id) {\n      continue;\n    }\n    if (!(entity.device_id in deviceEntityLookup)) {\n      deviceEntityLookup[entity.device_id] = [];\n    }\n    deviceEntityLookup[entity.device_id].push(entity);\n  }\n  return deviceEntityLookup;\n};\n\ntype FloorAreaLookup = Record<string, AreaRegistryEntry[]>;\n\nconst floorCompare = (entries?: Record<string, FloorRegistryEntry>, order?: string[]) => (a: string, b: string) => {\n  const indexA = order ? order.indexOf(a) : -1;\n  const indexB = order ? order.indexOf(b) : -1;\n  if (indexA === -1 && indexB === -1) {\n    const floorA = entries?.[a];\n    const floorB = entries?.[b];\n    if (floorA && floorB && floorA.level !== floorB.level) {\n      return (floorB.level ?? -9999) - (floorA.level ?? -9999);\n    }\n    const nameA = floorA?.name ?? a;\n    const nameB = floorB?.name ?? b;\n    return stringCompare(nameA, nameB);\n  }\n  if (indexA === -1) {\n    return 1;\n  }\n  if (indexB === -1) {\n    return -1;\n  }\n  return indexA - indexB;\n};\n\nexport const getFloorAreaLookup = (areas: AreaRegistryEntry[]): FloorAreaLookup => {\n  const floorAreaLookup: FloorAreaLookup = {};\n  for (const area of areas) {\n    if (!area.floor_id) {\n      continue;\n    }\n    if (!(area.floor_id in floorAreaLookup)) {\n      floorAreaLookup[area.floor_id] = [];\n    }\n    floorAreaLookup[area.floor_id].push(area);\n  }\n  return floorAreaLookup;\n};\n\nexport const useAreas = (\n  includeDomains?: string[],\n  excludeDomains?: string[],\n  includeDeviceClasses?: string[],\n  deviceFilter?: (device: DeviceRegistryEntry) => boolean,\n  entityFilter?: (entityId: HassEntity) => boolean,\n  excludeAreas?: string[],\n  excludeFloors?: string[],\n): UseAreasReturn[] => {\n  const { joinHassUrl } = useHass.getState().helpers;\n  const _entities = useHass((store) => store.entities);\n  const _entitiesRegistryDisplay = useHass((store) => store.entitiesRegistryDisplay);\n  const _devices = useHass((store) => store.devices);\n  const _areas = useHass((store) => store.areas);\n  const _floors = useHass((store) => store.floors);\n  const floors = Object.values(_floors);\n  const areas = Object.values(_areas);\n  const devices = Object.values(_devices);\n  const entities = Object.values(_entitiesRegistryDisplay);\n\n  let deviceEntityLookup: DeviceEntityDisplayLookup = {};\n  let inputDevices: DeviceRegistryEntry[] | undefined;\n  let inputEntities: EntityRegistryDisplayEntry[] | undefined;\n\n  if (includeDomains || excludeDomains || includeDeviceClasses || deviceFilter || entityFilter) {\n    deviceEntityLookup = getDeviceEntityDisplayLookup(entities);\n    inputDevices = devices;\n    inputEntities = entities.filter((entity) => entity.area_id);\n\n    if (includeDomains) {\n      inputDevices = inputDevices!.filter((device) => {\n        const devEntities = deviceEntityLookup[device.id];\n        if (!devEntities || !devEntities.length) {\n          return false;\n        }\n        return deviceEntityLookup[device.id].some((entity) => includeDomains.includes(computeDomain(entity.entity_id as EntityName)));\n      });\n      inputEntities = inputEntities!.filter((entity) => includeDomains.includes(computeDomain(entity.entity_id as EntityName)));\n    }\n\n    if (excludeDomains) {\n      inputDevices = inputDevices!.filter((device) => {\n        const devEntities = deviceEntityLookup[device.id];\n        if (!devEntities || !devEntities.length) {\n          return true;\n        }\n        return entities.every((entity) => !excludeDomains.includes(computeDomain(entity.entity_id as EntityName)));\n      });\n      inputEntities = inputEntities!.filter((entity) => !excludeDomains.includes(computeDomain(entity.entity_id as EntityName)));\n    }\n\n    if (includeDeviceClasses) {\n      inputDevices = inputDevices!.filter((device) => {\n        const devEntities = deviceEntityLookup[device.id];\n        if (!devEntities || !devEntities.length) {\n          return false;\n        }\n        return deviceEntityLookup[device.id].some((entity) => {\n          const stateObj = _entities[entity.entity_id];\n          if (!stateObj) {\n            return false;\n          }\n          return stateObj.attributes.device_class && includeDeviceClasses.includes(stateObj.attributes.device_class);\n        });\n      });\n      inputEntities = inputEntities!.filter((entity) => {\n        const stateObj = _entities[entity.entity_id];\n        return stateObj.attributes.device_class && includeDeviceClasses.includes(stateObj.attributes.device_class);\n      });\n    }\n\n    if (deviceFilter) {\n      inputDevices = inputDevices!.filter((device) => deviceFilter!(device));\n    }\n\n    if (entityFilter) {\n      inputDevices = inputDevices!.filter((device) => {\n        const devEntities = deviceEntityLookup[device.id];\n        if (!devEntities || !devEntities.length) {\n          return false;\n        }\n        return deviceEntityLookup[device.id].some((entity) => {\n          const stateObj = _entities[entity.entity_id];\n          if (!stateObj) {\n            return false;\n          }\n          return entityFilter(stateObj);\n        });\n      });\n      inputEntities = inputEntities!.filter((entity) => {\n        const stateObj = _entities[entity.entity_id];\n        if (!stateObj) {\n          return false;\n        }\n        return entityFilter!(stateObj);\n      });\n    }\n  }\n\n  let outputAreas = areas.map((area) => ({\n    ...area,\n    picture: area.picture ? joinHassUrl(area.picture) : area.picture,\n  }));\n\n  let areaIds: string[] | undefined;\n\n  if (inputDevices) {\n    areaIds = inputDevices.filter((device) => device.area_id).map((device) => device.area_id!);\n  }\n\n  if (inputEntities) {\n    areaIds = (areaIds ?? []).concat(inputEntities.filter((entity) => entity.area_id).map((entity) => entity.area_id!));\n  }\n\n  if (areaIds) {\n    outputAreas = outputAreas.filter((area) => areaIds!.includes(area.area_id));\n  }\n\n  if (excludeAreas) {\n    outputAreas = outputAreas.filter((area) => !excludeAreas!.includes(area.area_id));\n  }\n\n  if (excludeFloors) {\n    outputAreas = outputAreas.filter((area) => !area.floor_id || !excludeFloors!.includes(area.floor_id));\n  }\n\n  const floorAreaLookup = getFloorAreaLookup(outputAreas);\n  const unassignedAreas = Object.values(outputAreas).filter((area) => !area.floor_id || !floorAreaLookup[area.floor_id]);\n\n  const compare = floorCompare(_floors);\n  // @ts-expect-error - fix later\n  const floorAreaEntries: [FloorRegistryEntry | undefined, AreaRegistryEntry[]][] = Object.entries(floorAreaLookup)\n    .map(([floorId, floorAreas]) => {\n      const floor = floors.find((fl) => fl.floor_id === floorId)!;\n      return [floor, floorAreas] as const;\n    })\n    .sort(([floorA], [floorB]) => compare(floorA.floor_id, floorB.floor_id));\n\n  const items: UseAreasReturn[] = [];\n\n  floorAreaEntries.forEach(([floor, floorAreas]) => {\n    if (floor) {\n      const floorName = computeFloorName(floor);\n\n      const areaSearchLabels = floorAreas\n        .map((area) => {\n          const areaName = computeAreaName(area) || area.area_id;\n          return [area.area_id, areaName, ...area.aliases];\n        })\n        .flat();\n\n      items.push({\n        id: [\"floor\", floor.floor_id].join(\"______\"),\n        type: \"floor\",\n        primary: floorName,\n        floor: floor,\n        icon: floor.icon || undefined,\n        search_labels: [floor.floor_id, floorName, ...floor.aliases, ...areaSearchLabels],\n      });\n    }\n    items.push(\n      ...floorAreas.map((area) => {\n        const areaName = computeAreaName(area) || area.area_id;\n        return {\n          id: [\"area\", area.area_id].join(\"______\"),\n          type: \"area\" as const,\n          primary: areaName,\n          area: area,\n          icon: area.icon || undefined,\n          search_labels: [area.area_id, areaName, ...area.aliases],\n        };\n      }),\n    );\n  });\n\n  items.push(\n    ...unassignedAreas.map((area) => {\n      const areaName = computeAreaName(area) || area.area_id;\n      return {\n        id: [\"area\", area.area_id].join(\"______\"),\n        type: \"area\" as const,\n        primary: areaName,\n        area: area,\n        icon: area.icon || undefined,\n        search_labels: [area.area_id, areaName, ...area.aliases],\n      };\n    }),\n  );\n\n  return items;\n};\n"],"names":["getDeviceEntityDisplayLookup","entities","deviceEntityLookup","entity","floorCompare","entries","order","a","b","floorA","floorB","nameA","nameB","stringCompare","getFloorAreaLookup","areas","floorAreaLookup","area","useAreas","includeDomains","excludeDomains","includeDeviceClasses","deviceFilter","entityFilter","excludeAreas","excludeFloors","joinHassUrl","useHass","_entities","store","_entitiesRegistryDisplay","_devices","_areas","_floors","floors","devices","inputDevices","inputEntities","device","devEntities","computeDomain","stateObj","outputAreas","areaIds","unassignedAreas","compare","floorAreaEntries","floorId","floorAreas","fl","items","floor","floorName","computeFloorName","areaSearchLabels","areaName","computeAreaName"],"mappings":"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"}