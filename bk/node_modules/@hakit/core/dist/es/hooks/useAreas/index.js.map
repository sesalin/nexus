{"version":3,"file":"index.js","sources":["../../../../src/hooks/useAreas/index.ts"],"sourcesContent":["import { AreaRegistryEntry, EntityRegistryDisplayEntry, useHass } from \"@core\";\nimport { useMemo } from \"react\";\nimport type { DeviceRegistryEntry } from \"@utils/subscribe/devices\";\nimport type { HassEntity } from \"home-assistant-js-websocket\";\nimport type { FloorRegistryEntry } from \"@utils/subscribe/floors\";\n\n/**\n * Enriched area shape returned by `useAreas`.\n * Extends the raw registry entry with resolved picture URL, linked floor,\n * concrete lists of devices & entities.\n */\nexport interface Area extends AreaRegistryEntry {\n  /** Resolved (absolute) picture URL or null */\n  picture: string | null;\n  /** Devices (non-service type) whose area_id matches this area */\n  devices: DeviceRegistryEntry[];\n  /** Entities (state objects) whose area_id matches this area */\n  entities: HassEntity[];\n  /** Associated floor (null if none assigned) */\n  floor: FloorRegistryEntry | null;\n}\n\nexport function useAreas(): Area[] {\n  const { joinHassUrl } = useHass.getState().helpers;\n  const areas = useHass((state) => state.areas);\n  const devices = useHass((state) => state.devices);\n  const floors = useHass((state) => state.floors);\n  const entitiesRegistryDisplay = useHass((state) => state.entitiesRegistryDisplay);\n  const entities = useHass((state) => state.entities);\n\n  return useMemo(() => {\n    const _areas = Object.values(areas);\n    return processAreas({\n      areas: _areas,\n      devices,\n      entitiesRegistryDisplay,\n      floors,\n      joinHassUrl,\n      hassEntities: entities,\n    });\n  }, [areas, devices, joinHassUrl, entitiesRegistryDisplay, floors, entities]);\n}\ninterface ProcessAreasParams {\n  areas: AreaRegistryEntry[];\n  devices: Record<string, DeviceRegistryEntry>;\n  entitiesRegistryDisplay: Record<string, EntityRegistryDisplayEntry>;\n  floors: Record<string, FloorRegistryEntry>;\n  joinHassUrl: (path: string) => string;\n  hassEntities: Record<string, HassEntity>;\n}\n\nfunction processAreas({ areas, devices, entitiesRegistryDisplay, floors, joinHassUrl, hassEntities }: ProcessAreasParams): Area[] {\n  const processArea = (area: AreaRegistryEntry): Area => {\n    const devicesInArea: DeviceRegistryEntry[] = [];\n    for (const device of Object.values(devices)) {\n      if (device.area_id === area.area_id) {\n        if (device.entry_type !== \"service\") {\n          devicesInArea.push(device);\n        }\n      }\n    }\n\n    // Collect entities that belong to this area either directly (entity.area_id) or\n    // indirectly via the device assignment (entity.area_id unset but device.area_id matches).\n    const entitiesInAreaSet = new Set<string>();\n    const entitiesInArea: HassEntity[] = [];\n    for (const entity of Object.values(entitiesRegistryDisplay)) {\n      const directMatch = entity.area_id === area.area_id;\n      const inheritedMatch = !entity.area_id && entity.device_id && devices[entity.device_id]?.area_id === area.area_id;\n      if (directMatch || inheritedMatch) {\n        const hassEntity = hassEntities[entity.entity_id];\n        if (hassEntity && !entitiesInAreaSet.has(entity.entity_id)) {\n          entitiesInAreaSet.add(entity.entity_id);\n          entitiesInArea.push(hassEntity);\n        } else if (!hassEntity) {\n          // Registry entry exists but we have no current state object; skip silently.\n          // (Could log if needed: console.debug(`Missing state for ${entity.entity_id}`))\n        }\n      }\n    }\n\n    return {\n      ...area,\n      picture: area.picture ? joinHassUrl(area.picture) : null,\n      devices: devicesInArea,\n      entities: entitiesInArea,\n      floor: area.floor_id ? floors[area.floor_id] || null : null,\n    };\n  };\n\n  return areas.map(processArea);\n}\n"],"names":["useAreas","joinHassUrl","useHass","areas","state","devices","floors","entitiesRegistryDisplay","entities","useMemo","_areas","processAreas","hassEntities","processArea","area","devicesInArea","device","entitiesInAreaSet","entitiesInArea","entity","directMatch","inheritedMatch","hassEntity"],"mappings":";;;;;;;;AAsBO,SAASA,IAAmB;AACjC,QAAM,EAAE,aAAAC,EAAA,IAAgBC,EAAQ,WAAW,SACrCC,IAAQD,EAAQ,CAACE,MAAUA,EAAM,KAAK,GACtCC,IAAUH,EAAQ,CAACE,MAAUA,EAAM,OAAO,GAC1CE,IAASJ,EAAQ,CAACE,MAAUA,EAAM,MAAM,GACxCG,IAA0BL,EAAQ,CAACE,MAAUA,EAAM,uBAAuB,GAC1EI,IAAWN,EAAQ,CAACE,MAAUA,EAAM,QAAQ;AAElD,SAAOK,EAAQ,MAAM;AACnB,UAAMC,IAAS,OAAO,OAAOP,CAAK;AAClC,WAAOQ,EAAa;AAAA,MAClB,OAAOD;AAAA,MACP,SAAAL;AAAA,MACA,yBAAAE;AAAA,MACA,QAAAD;AAAA,MACA,aAAAL;AAAA,MACA,cAAcO;AAAA,IAAA,CACf;AAAA,EACH,GAAG,CAACL,GAAOE,GAASJ,GAAaM,GAAyBD,GAAQE,CAAQ,CAAC;AAC7E;AAUA,SAASG,EAAa,EAAE,OAAAR,GAAO,SAAAE,GAAS,yBAAAE,GAAyB,QAAAD,GAAQ,aAAAL,GAAa,cAAAW,KAA4C;AAChI,QAAMC,IAAc,CAACC,MAAkC;AACrD,UAAMC,IAAuC,CAAA;AAC7C,eAAWC,KAAU,OAAO,OAAOX,CAAO;AACxC,MAAIW,EAAO,YAAYF,EAAK,WACtBE,EAAO,eAAe,aACxBD,EAAc,KAAKC,CAAM;AAO/B,UAAMC,wBAAwB,IAAA,GACxBC,IAA+B,CAAA;AACrC,eAAWC,KAAU,OAAO,OAAOZ,CAAuB,GAAG;AAC3D,YAAMa,IAAcD,EAAO,YAAYL,EAAK,SACtCO,IAAiB,CAACF,EAAO,WAAWA,EAAO,aAAad,EAAQc,EAAO,SAAS,GAAG,YAAYL,EAAK;AAC1G,UAAIM,KAAeC,GAAgB;AACjC,cAAMC,IAAaV,EAAaO,EAAO,SAAS;AAChD,QAAIG,KAAc,CAACL,EAAkB,IAAIE,EAAO,SAAS,MACvDF,EAAkB,IAAIE,EAAO,SAAS,GACtCD,EAAe,KAAKI,CAAU;AAAA,MAKlC;AAAA,IACF;AAEA,WAAO;AAAA,MACL,GAAGR;AAAA,MACH,SAASA,EAAK,UAAUb,EAAYa,EAAK,OAAO,IAAI;AAAA,MACpD,SAASC;AAAA,MACT,UAAUG;AAAA,MACV,OAAOJ,EAAK,YAAWR,EAAOQ,EAAK,QAAQ,KAAK;AAAA,IAAO;AAAA,EAE3D;AAEA,SAAOX,EAAM,IAAIU,CAAW;AAC9B;"}