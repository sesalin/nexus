{"version":3,"file":"helpers.js","sources":["../../../../src/hooks/useWeather/helpers.ts"],"sourcesContent":["import { type WeatherEntity, type FilterByDomain, type EntityName, supportsFeatureFromAttributes } from \"@core\";\nimport type { Connection, HassEntityBase } from \"home-assistant-js-websocket\";\n\nexport const enum WeatherEntityFeature {\n  FORECAST_DAILY = 1,\n  FORECAST_HOURLY = 2,\n  FORECAST_TWICE_DAILY = 4,\n}\n\ntype ForecastAttribute = NonNullable<WeatherEntity[\"attributes\"][\"forecast\"]>[number];\n\nexport type ModernForecastType = \"hourly\" | \"daily\" | \"twice_daily\";\n\nexport interface ForecastEvent {\n  type: ModernForecastType;\n  forecast: [ForecastAttribute] | null;\n}\n\nexport type ForecastType = ModernForecastType | \"legacy\";\n\nconst EIGHT_HOURS = 28800000;\nconst DAY_IN_MILLISECONDS = 86400000;\n\nconst isForecastHourly = (forecast?: ForecastAttribute[]): boolean | undefined => {\n  if (forecast && forecast?.length && forecast?.length > 2) {\n    const date1 = new Date(forecast[1].datetime);\n    const date2 = new Date(forecast[2].datetime);\n    const timeDiff = date2.getTime() - date1.getTime();\n\n    return timeDiff < EIGHT_HOURS;\n  }\n\n  return undefined;\n};\n\nconst isForecastTwiceDaily = (forecast?: ForecastAttribute[]): boolean | undefined => {\n  if (forecast && forecast?.length && forecast?.length > 2) {\n    const date1 = new Date(forecast[1].datetime);\n    const date2 = new Date(forecast[2].datetime);\n    const timeDiff = date2.getTime() - date1.getTime();\n\n    return timeDiff < DAY_IN_MILLISECONDS;\n  }\n\n  return undefined;\n};\n\nconst getLegacyForecast = (\n  weather_attributes?: WeatherEntity[\"attributes\"] | undefined,\n):\n  | {\n      forecast: ForecastAttribute[];\n      type: \"daily\" | \"hourly\" | \"twice_daily\";\n    }\n  | undefined => {\n  if (weather_attributes?.forecast && weather_attributes.forecast.length > 2) {\n    if (isForecastHourly(weather_attributes.forecast)) {\n      return {\n        forecast: weather_attributes.forecast,\n        type: \"hourly\",\n      };\n    }\n    if (isForecastTwiceDaily(weather_attributes.forecast)) {\n      return {\n        forecast: weather_attributes.forecast,\n        type: \"twice_daily\",\n      };\n    }\n    return { forecast: weather_attributes.forecast, type: \"daily\" };\n  }\n  return undefined;\n};\n\nexport type Forecast =\n  | {\n      forecast: ForecastAttribute[];\n      type: \"daily\" | \"hourly\" | \"twice_daily\";\n    }\n  | undefined;\n\nexport const getForecast = (\n  weather_attributes: WeatherEntity[\"attributes\"],\n  forecast_event: ForecastEvent | null,\n  forecast_type?: ForecastType | undefined,\n): Forecast => {\n  if (forecast_type === undefined) {\n    if (forecast_event?.type !== undefined && forecast_event?.forecast && forecast_event?.forecast?.length > 2) {\n      return { forecast: forecast_event.forecast, type: forecast_event?.type };\n    }\n    return getLegacyForecast(weather_attributes);\n  }\n\n  if (forecast_type === \"legacy\") {\n    return getLegacyForecast(weather_attributes);\n  }\n\n  if (forecast_type === forecast_event?.type && forecast_event?.forecast && forecast_event?.forecast?.length > 2) {\n    return { forecast: forecast_event.forecast, type: forecast_type };\n  }\n\n  return undefined;\n};\n\nexport const subscribeForecast = (\n  connection: Connection,\n  entity_id: FilterByDomain<EntityName, \"weather\">,\n  forecast_type: ModernForecastType,\n  callback: (forecastevent: ForecastEvent) => void,\n) =>\n  connection.subscribeMessage<ForecastEvent>(callback, {\n    type: \"weather/subscribe_forecast\",\n    forecast_type,\n    entity_id,\n  });\n\nexport const getSupportedForecastTypes = (entity: HassEntityBase): ModernForecastType[] => {\n  const supported: ModernForecastType[] = [];\n  if (supportsFeatureFromAttributes(entity.attributes, WeatherEntityFeature.FORECAST_DAILY)) {\n    supported.push(\"daily\");\n  }\n  if (supportsFeatureFromAttributes(entity.attributes, WeatherEntityFeature.FORECAST_TWICE_DAILY)) {\n    supported.push(\"twice_daily\");\n  }\n  if (supportsFeatureFromAttributes(entity.attributes, WeatherEntityFeature.FORECAST_HOURLY)) {\n    supported.push(\"hourly\");\n  }\n  return supported;\n};\n\nexport const getDefaultForecastType = (entity: HassEntityBase) => {\n  if (supportsFeatureFromAttributes(entity.attributes, WeatherEntityFeature.FORECAST_DAILY)) {\n    return \"daily\";\n  }\n  if (supportsFeatureFromAttributes(entity.attributes, WeatherEntityFeature.FORECAST_TWICE_DAILY)) {\n    return \"twice_daily\";\n  }\n  if (supportsFeatureFromAttributes(entity.attributes, WeatherEntityFeature.FORECAST_HOURLY)) {\n    return \"hourly\";\n  }\n  return undefined;\n};\n"],"names":["WeatherEntityFeature","EIGHT_HOURS","DAY_IN_MILLISECONDS","isForecastHourly","forecast","date1","isForecastTwiceDaily","getLegacyForecast","weather_attributes","getForecast","forecast_event","forecast_type","subscribeForecast","connection","entity_id","callback","getSupportedForecastTypes","entity","supported","supportsFeatureFromAttributes","getDefaultForecastType"],"mappings":";;;;;;;;;AAGO,IAAWA,sBAAAA,OAChBA,EAAAA,EAAA,iBAAiB,CAAA,IAAjB,kBACAA,EAAAA,EAAA,kBAAkB,CAAA,IAAlB,mBACAA,EAAAA,EAAA,uBAAuB,CAAA,IAAvB,wBAHgBA,IAAAA,KAAA,CAAA,CAAA;AAiBlB,MAAMC,IAAc,OACdC,IAAsB,OAEtBC,IAAmB,CAACC,MAAwD;AAChF,MAAIA,KAAYA,GAAU,UAAUA,GAAU,SAAS,GAAG;AACxD,UAAMC,IAAQ,IAAI,KAAKD,EAAS,CAAC,EAAE,QAAQ;AAI3C,WAHc,IAAI,KAAKA,EAAS,CAAC,EAAE,QAAQ,EACpB,QAAA,IAAYC,EAAM,QAAA,IAEvBJ;AAAA,EACpB;AAGF,GAEMK,IAAuB,CAACF,MAAwD;AACpF,MAAIA,KAAYA,GAAU,UAAUA,GAAU,SAAS,GAAG;AACxD,UAAMC,IAAQ,IAAI,KAAKD,EAAS,CAAC,EAAE,QAAQ;AAI3C,WAHc,IAAI,KAAKA,EAAS,CAAC,EAAE,QAAQ,EACpB,QAAA,IAAYC,EAAM,QAAA,IAEvBH;AAAA,EACpB;AAGF,GAEMK,IAAoB,CACxBC,MAMe;AACf,MAAIA,GAAoB,YAAYA,EAAmB,SAAS,SAAS;AACvE,WAAIL,EAAiBK,EAAmB,QAAQ,IACvC;AAAA,MACL,UAAUA,EAAmB;AAAA,MAC7B,MAAM;AAAA,IAAA,IAGNF,EAAqBE,EAAmB,QAAQ,IAC3C;AAAA,MACL,UAAUA,EAAmB;AAAA,MAC7B,MAAM;AAAA,IAAA,IAGH,EAAE,UAAUA,EAAmB,UAAU,MAAM,QAAA;AAG1D,GASaC,IAAc,CACzBD,GACAE,GACAC,MACa;AACb,MAAIA,MAAkB;AACpB,WAAID,GAAgB,SAAS,UAAaA,GAAgB,YAAYA,GAAgB,UAAU,SAAS,IAChG,EAAE,UAAUA,EAAe,UAAU,MAAMA,GAAgB,KAAA,IAE7DH,EAAkBC,CAAkB;AAG7C,MAAIG,MAAkB;AACpB,WAAOJ,EAAkBC,CAAkB;AAG7C,MAAIG,MAAkBD,GAAgB,QAAQA,GAAgB,YAAYA,GAAgB,UAAU,SAAS;AAC3G,WAAO,EAAE,UAAUA,EAAe,UAAU,MAAMC,EAAA;AAItD,GAEaC,IAAoB,CAC/BC,GACAC,GACAH,GACAI,MAEAF,EAAW,iBAAgCE,GAAU;AAAA,EACnD,MAAM;AAAA,EACN,eAAAJ;AAAA,EACA,WAAAG;AACF,CAAC,GAEUE,IAA4B,CAACC,MAAiD;AACzF,QAAMC,IAAkC,CAAA;AACxC,SAAIC;AAAA,IAA8BF,EAAO;AAAA,IAAY;AAAA;AAAA,EAAA,KACnDC,EAAU,KAAK,OAAO,GAEpBC;AAAA,IAA8BF,EAAO;AAAA,IAAY;AAAA;AAAA,EAAA,KACnDC,EAAU,KAAK,aAAa,GAE1BC;AAAA,IAA8BF,EAAO;AAAA,IAAY;AAAA;AAAA,EAAA,KACnDC,EAAU,KAAK,QAAQ,GAElBA;AACT,GAEaE,IAAyB,CAACH,MAA2B;AAChE,MAAIE;AAAA,IAA8BF,EAAO;AAAA,IAAY;AAAA;AAAA,EAAA;AACnD,WAAO;AAET,MAAIE;AAAA,IAA8BF,EAAO;AAAA,IAAY;AAAA;AAAA,EAAA;AACnD,WAAO;AAET,MAAIE;AAAA,IAA8BF,EAAO;AAAA,IAAY;AAAA;AAAA,EAAA;AACnD,WAAO;AAGX;"}