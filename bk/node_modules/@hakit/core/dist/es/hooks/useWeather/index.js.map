{"version":3,"file":"index.js","sources":["../../../../src/hooks/useWeather/index.ts"],"sourcesContent":["import { useCallback, useState, useMemo, useEffect, useRef } from \"react\";\nimport { type EntityName, type FilterByDomain, type WeatherEntity, useHass, useEntity, HassEntityWithService } from \"@core\";\nimport type { Connection } from \"home-assistant-js-websocket\";\nimport { useDebouncedCallback } from \"use-debounce\";\n\nimport { type ModernForecastType, type ForecastEvent, getForecast, subscribeForecast, type Forecast } from \"./helpers\";\n\nexport interface UseWeatherOptions {\n  type: ModernForecastType;\n}\n\nexport interface WeatherEntityExtended extends WeatherEntity {\n  forecast: ForecastEvent | null;\n}\n\nexport type WeatherEntityWithForecast = HassEntityWithService<\"weather\"> & {\n  forecast: Forecast;\n};\n\nexport function useWeather(entityId: FilterByDomain<EntityName, \"weather\">, options?: UseWeatherOptions): WeatherEntityWithForecast {\n  const connection = useHass((state) => state.connection);\n  const _entity = useEntity(entityId);\n  const [error, setError] = useState<string | null>(null);\n  const [forecastEvent, setForecastEvent] = useState<ForecastEvent | null>(null);\n  const _subscribed = useRef<boolean>(false);\n  const _unsubscribe = useRef<void | (() => Promise<void>)>(undefined);\n\n  const { type = \"daily\" } = options || {};\n\n  const subscribeWeatherEvents = useCallback(\n    (entityId: FilterByDomain<EntityName, \"weather\">, type: ModernForecastType) => {\n      const unsubscribe = subscribeForecast(connection as Connection, entityId, type, (streamMessage) => {\n        // If we receive an event after subscription if false, we most likely\n        // have been unmounted and no need to set the state\n        if (!_subscribed.current) return;\n        setForecastEvent(streamMessage);\n      }).catch((err) => {\n        _subscribed.current = false;\n        if (err instanceof Error) {\n          setError(err.message);\n        }\n      });\n      return unsubscribe;\n    },\n    [connection],\n  );\n\n  const debounceSubscribeWeatherEvents = useDebouncedCallback(\n    async (entityId: FilterByDomain<EntityName, \"weather\">, type: ModernForecastType) => {\n      if (_unsubscribe.current) {\n        const unsubscribe = await _unsubscribe.current;\n        if (unsubscribe) unsubscribe();\n        _unsubscribe.current = undefined;\n      }\n      _subscribed.current = true;\n      _unsubscribe.current = await subscribeWeatherEvents(entityId, type);\n    },\n    100,\n    {\n      trailing: true,\n      leading: true,\n    },\n  );\n\n  useEffect(() => {\n    debounceSubscribeWeatherEvents(entityId, type);\n\n    return () => {\n      _subscribed.current = false;\n      if (_unsubscribe.current) {\n        _unsubscribe.current();\n      }\n    };\n  }, [type, debounceSubscribeWeatherEvents, subscribeWeatherEvents, entityId]);\n\n  if (error) {\n    throw error;\n  }\n\n  return useMemo(() => {\n    const forecastData = getForecast(_entity.attributes, forecastEvent);\n    return {\n      ..._entity,\n      forecast: forecastData,\n    };\n  }, [_entity, forecastEvent]);\n}\n"],"names":["useWeather","entityId","options","connection","useHass","state","_entity","useEntity","error","setError","useState","forecastEvent","setForecastEvent","_subscribed","useRef","_unsubscribe","type","subscribeWeatherEvents","useCallback","subscribeForecast","streamMessage","err","debounceSubscribeWeatherEvents","useDebouncedCallback","unsubscribe","useEffect","useMemo","forecastData","getForecast"],"mappings":";;;;;;;;;;AAmBO,SAASA,EAAWC,GAAiDC,GAAwD;AAClI,QAAMC,IAAaC,EAAQ,CAACC,MAAUA,EAAM,UAAU,GAChDC,IAAUC,EAAUN,CAAQ,GAC5B,CAACO,GAAOC,CAAQ,IAAIC,EAAwB,IAAI,GAChD,CAACC,GAAeC,CAAgB,IAAIF,EAA+B,IAAI,GACvEG,IAAcC,EAAgB,EAAK,GACnCC,IAAeD,EAAqC,MAAS,GAE7D,EAAE,MAAAE,IAAO,QAAA,IAAYd,KAAW,CAAA,GAEhCe,IAAyBC;AAAA,IAC7B,CAACjB,GAAiDe,MAC5BG,EAAkBhB,GAA0BF,GAAUe,GAAM,CAACI,MAAkB;AAGjG,MAAKP,EAAY,WACjBD,EAAiBQ,CAAa;AAAA,IAChC,CAAC,EAAE,MAAM,CAACC,MAAQ;AAChB,MAAAR,EAAY,UAAU,IAClBQ,aAAe,SACjBZ,EAASY,EAAI,OAAO;AAAA,IAExB,CAAC;AAAA,IAGH,CAAClB,CAAU;AAAA,EAAA,GAGPmB,IAAiCC;AAAA,IACrC,OAAOtB,GAAiDe,MAA6B;AACnF,UAAID,EAAa,SAAS;AACxB,cAAMS,IAAc,MAAMT,EAAa;AACvC,QAAIS,KAAaA,EAAA,GACjBT,EAAa,UAAU;AAAA,MACzB;AACA,MAAAF,EAAY,UAAU,IACtBE,EAAa,UAAU,MAAME,EAAuBhB,GAAUe,CAAI;AAAA,IACpE;AAAA,IACA;AAAA,IACA;AAAA,MACE,UAAU;AAAA,MACV,SAAS;AAAA,IAAA;AAAA,EACX;AAcF,MAXAS,EAAU,OACRH,EAA+BrB,GAAUe,CAAI,GAEtC,MAAM;AACX,IAAAH,EAAY,UAAU,IAClBE,EAAa,WACfA,EAAa,QAAA;AAAA,EAEjB,IACC,CAACC,GAAMM,GAAgCL,GAAwBhB,CAAQ,CAAC,GAEvEO;AACF,UAAMA;AAGR,SAAOkB,EAAQ,MAAM;AACnB,UAAMC,IAAeC,EAAYtB,EAAQ,YAAYK,CAAa;AAClE,WAAO;AAAA,MACL,GAAGL;AAAA,MACH,UAAUqB;AAAA,IAAA;AAAA,EAEd,GAAG,CAACrB,GAASK,CAAa,CAAC;AAC7B;"}