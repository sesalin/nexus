<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Auth Callback</title>
</head>
<body>
  <script>
    (async () => {
      const params = new URLSearchParams(window.location.search);
      const code = params.get('code');
      if (!code) {
        alert('Falta código de autorización');
        window.location.href = '/login/index.html';
        return;
      }
      try {
        const origin = window.location.origin;
        const body = new URLSearchParams();
        body.set('grant_type', 'authorization_code');
        body.set('code', code);
        body.set('client_id', origin);

        const res = await fetch('/auth/token', {
          method: 'POST',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
          credentials: 'include',
          body
        });
        if (!res.ok) throw new Error('token_exchange_failed');
        const data = await res.json();
        const expiresAt = Date.now() + (data.expires_in * 1000);
        localStorage.setItem('ha_access_token', data.access_token);
        localStorage.setItem('ha_refresh_token', data.refresh_token || '');
        localStorage.setItem('ha_token_expires_at', String(expiresAt));
        window.location.href = '/#/dashboard';
      } catch (e) {
        console.error(e);
        alert('No se pudo completar la autenticación');
        window.location.href = '/login/index.html';
      }
    })();
  </script>
</body>
</html>
